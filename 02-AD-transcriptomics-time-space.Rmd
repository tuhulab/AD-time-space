# AD transcriptomic profiling in time and space

## Load packages and environment variable

```{r load packages and environment variable, echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load(tibble, dplyr, tidyr, readr, stringr, ggplot2, purrr, 
               tidybulk, tidySummarizedExperiment, 
               ComplexHeatmap, ggpubr,
               BiocParallel, Biobase, variancePartition,
               DESeq2, limma, edgeR, MuSiC, convert, 
               patchwork)
knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE, 
                      echo = FALSE, 
                      fig.align = 'center')
pca_color <- c("LS" = "#eb2d0c", "NL" = "#eb8b9b", "HC" = "#91cf60")
core_n <- future::availableCores()
register(MulticoreParam(ifelse(core_n <= 8, core_n - 2, core_n / 2)))
```

```{r load data}
# read raw counts ---------------------------------------
counts <-
  data.table::fread("../multiomics-ad-transcriptomics/data/counts/counts_gene_name_redo.txt.gz") %>% 
  mutate(Chr = Chr %>% str_extract("chr\\w{1,}(?=;)|chr\\w{1,}$"), #keeps only 1
         Strand = Strand %>% str_extract("\\+|\\-"),               #keeps only 1
         Start = Start %>% str_extract("\\d{1,}(?=;)|\\d{1,}$"),   #keeps only 1
         End = End %>% str_extract("\\d{1,}(?=;)|\\d{1,}$")) %>%   #keeps only 1
  filter(!Geneid %>% 
           stringr::str_detect("\\d{1,}P$|\\d{1,}P\\d{1,}$|\\.|-AS\\d{1}|-DT")) %>% # apply gene filtering (pseudo genes, antisense genese, DT genes)
  dplyr::rename_with(str_extract, starts_with("/home/projects/"), pattern = "NG-[:graph:]{1,}$")

# lib to merge -------------
lib_id <- colnames(counts)[-1:-6] %>% str_extract("lib\\d{1,}") # extract lib id
lib_id_t <- table(lib_id)
lib_id_merge <- lib_id_t[(lib_id_t != 1)] %>% rownames() #lib_ids to be merged

# merge technical replicates -------------------------------------------
source("../multiomics-ad-transcriptomics/R/helper.R")

counttable_LibMerged <- 
  bind_cols(counts[, 1:6], 
            counttable_merge_library_fun(counts %>% dplyr::select(-1:-6), lib_id_merge)) 

# clinical records ------------------------
clinical_records <- 
  readr::read_csv("../multiomics-ad-transcriptomics/data/LEO-AD-metadata.csv") %>% 
  mutate(id = id %>% str_replace("-", "_"),
         JOIN_ID = paste(id, paste0("0",visit_no), sep="_"))

extensive_meta <-
  readr::read_csv("../multiomics-ad-transcriptomics/data/RNAseq_sample_annotation(extensive).csv") %>% 
  mutate(
    skin_type_fitzpatrick_scale = skin_type_fitzpatrick_scale %>% as.factor()
      )
```

```{r SummarizedExperiment}
# revised biopsy area by Tanja
revised_biopsy_area <- 
  readr::read_csv("../multiomics-ad-transcriptomics/data/tanja_replicate_location.csv") %>% 
  mutate(biopsy_area = biopsy_area %>% str_replace_all(" ", "_"))

# revise space infomation
biopsy_area <- 
  extensive_meta %>% 
  select(BAM_ID, biopsy_area_old = biopsy_area) %>% 
  left_join(revised_biopsy_area %>% select(BAM_ID, biopsy_area)) %>% 
  mutate(biopsy_area = ifelse(is.na(biopsy_area), biopsy_area_old, biopsy_area)) %>% 
  mutate(biopsy_area = ifelse(biopsy_area == "læg", "leg", biopsy_area)) %>% 
  select(-biopsy_area_old) %>% 
  add_case(BAM_ID = "NG-23830_01_AD_07_BI_LS_01_E9_lib390881_6751_1.bam",
           biopsy_area = "arm")

# se col_data
col_data <-
  tibble(
    # definingn metadata --------------------------------------
    BAM_ID = colnames(counttable_LibMerged)[-1:-6]) %>% 
    mutate(sequencing_batch = BAM_ID %>% str_extract("NG-\\d{1,}"),
           group = BAM_ID %>% str_extract("AD|CO") %>% 
               forcats::fct_relevel(c("CO", "AD")),
           subject = BAM_ID %>% str_extract("(AD|CO)_\\d{2,}"),
           visit = BAM_ID %>% str_extract("\\d{2,}_(AD|CO)") %>% str_extract("\\d{2,}"),
           skin_type = BAM_ID %>% str_replace("TS", "LS") %>% str_extract("NN|NL|LS") %>% forcats::fct_relevel(c("NN", "NL", "LS")),
           replicate_ID = BAM_ID %>% str_replace("TS_BI", "BI_LS") %>% str_extract("(NN|NL|LS)_\\d{2,}") %>% str_extract("\\d{2,}"),
           library_ID = BAM_ID %>% str_extract("lib\\d{1,}"),
           sequencing_id = BAM_ID %>% str_extract("\\d{4}_(1|2)"),
           JOIN_ID = base::paste(subject, visit, sep = "_")) %>%
    left_join(clinical_records %>% select(id, gender) %>% filter(!is.na(gender)), by=c("subject"="id")) %>%
    left_join(clinical_records %>% select(JOIN_ID, scorad, scorad_objective, easi_total_score, date_visit)) %>% 
    select(-JOIN_ID) %>% 
    mutate(gender = gender %>% forcats::fct_relevel(c("female", "male"))) %>% 
    left_join(extensive_meta %>% select(BAM_ID, rna_quality, visit_quarter)) %>% 
    left_join(biopsy_area)

# Summarized Experiment--------------------
se <- SummarizedExperiment::SummarizedExperiment(
  assays = list(counts = counttable_LibMerged %>% select(-1:-6) %>% as.matrix),
  colData = col_data
)
names(se) <- counttable_LibMerged$Geneid
```

```{r filtering}
# filter out samples ----------------
se <- se[, se$BAM_ID != (assay(se) %>% colSums() %>% which.min %>% names)] # 392
se <- se[, !se$library_ID %in% c("lib390174", "lib390716")] # 390
```

```{r revise some sp info}
index_ad03v01ls01 <-
  which(colData(se)$subject == "AD_03" &
        colData(se)$visit == "01" &
        colData(se)$skin_type == "LS" &
        colData(se)$replicate_ID == "01")
colData(se)$skin_type[index_ad03v01ls01] <- "NL"

index_ad03v01nl01 <-
  which(colData(se)$subject == "AD_03" &
          colData(se)$visit == "01" &
          colData(se)$skin_type == "NL" &
          colData(se)$replicate_ID == "01")
colData(se)$skin_type[index_ad03v01nl01] <- "LS"

index_ad13v03nl01 <-
  which(colData(se)$subject == "AD_13" &
        colData(se)$visit == "03" &
        colData(se)$skin_type == "NL" &
        colData(se)$replicate_ID == "01")
colData(se)$visit[index_ad13v03nl01] <- "05"
colData(se)$skin_type[index_ad13v03nl01] <- "LS"
colData(se)$replicate_ID[index_ad13v03nl01] <- "02"

index_ad13v05ls02 <-
  which(colData(se)$subject == "AD_13" &
        colData(se)$visit == "05" &
        colData(se)$skin_type == "LS" &
        colData(se)$replicate_ID == "02")
colData(se)$visit[index_ad13v05ls02] <- "03"
colData(se)$skin_type[index_ad13v05ls02] <- "NL"
colData(se)$replicate_ID[index_ad13v05ls02] <- "01"
```

```{r Sample QC}
sample_qc_record_edited <-
  readr::read_csv("data/sample_qc_record - sample_qc_record.csv")
```

```{r exclude}
exclude_BAM <- 
  colData(se) %>% as_tibble() %>% 
  select(BAM_ID, subject, visit, skin_type, replicate_ID) %>%
  left_join(sample_qc_record_edited) %>% 
  filter(exclude == TRUE) %>% pull(BAM_ID)
```

```{r generate new se}
se <- se[, !se$BAM_ID %in% exclude_BAM]
colData(se)$biopsy_area <- colData(se)$biopsy_area %>% 
  str_extract("arm|back_of_knee|elbow|feet|hand|leg|wrist")

colData(se) <- 
  DataFrame(
  colData(se) %>% 
    as.data.frame() %>% 
    mutate(skin_type = as.character(skin_type),
           skin_type = ifelse(skin_type == "NN", "HC", skin_type),
           skin_type = forcats::fct_relevel(skin_type, c("HC", "NL", "LS")))
  )

g_non_pseudo <- 
  rownames(se) %>% 
  gprofiler2::gconvert() %>% 
  filter(!description %>% str_detect("pseudogene")) %>% 
  pull(input) %>% unique()

se <-
  se[g_non_pseudo,]

# make a cope of a non-filtered se
se_prifilt <- se

# filter out genes 
se <- 
  se_prifilt %>% 
  keep_abundant(minimum_proportion = 0) %>%
  scale_abundance()
```

```{r generate KRTAP}
se_KRTAP <- se_prifilt %>% 
  keep_abundant(factor_of_interest = skin_type, minimum_proportion = .1) %>%
  scale_abundance()
```

```{r KRTAP variance}
KRTAP_hair <-
  se_KRTAP %>% 
  filter(feature %>% str_detect("KRTAP")
           # c(paste0("KRTAP5-", 1:11), "KRTAP10-4")
         ) %>% 
  group_by(feature) %>% 
  summarise(mean_expr = mean(counts), 
            sd_expr = sd(counts)) %>%   
  mutate(expr = ifelse(mean_expr >= 10, TRUE, FALSE))

se_KRTAP_filt <- 
  se_KRTAP %>% 
  filter(feature %in% (KRTAP_hair %>% filter(expr == TRUE) %>% pull(feature)))
```

```{r write out data, eval=FALSE}
readr::write_rds(se, "data/se.rds")
readr::write_rds(se_KRTAP_filt, "data/se_krtap_all24.rds")
```

## Baseline characteristics

```{r baseline-statistics-table}
extensive_meta <- 
  readr::read_csv("../multiomics-ad-transcriptomics/data/RNAseq_sample_annotation(extensive).csv") 

baseline_data <-  
  extensive_meta %>% filter(visit == "01") %>% 
  select(subject, 
         group, 
         # t test
         age, 
         bmi, 
         contains("blood"),
         # fisher's exact test
         gender, 
         smoker,
         smoker_ever,
         animal,
         family_eczema,
         family_atopy,
         other_atopy,
         other_diagnoses,
         prick_test_result,
         # Mann-Whitney-Wilcoxon Test
         education,
         drinks_per_week,
         skin_type_fitzpatrick_scale,
         grow_up_where,
         # NOT FOR COMPARISON
         easi_total_score, scorad, 
         scorad_objective) %>% 
  distinct() %>% 
  mutate(ige_200h = ifelse(blood_ige > 200, TRUE, FALSE),
         gender_female = ifelse(gender == "female", T, F),
         family_eczema = ifelse(family_eczema == "-", 
                                F,
                                family_eczema),
         family_eczema = as.logical(family_eczema),
         other_atopy = ifelse(other_atopy == "-",
                              F,
                              other_atopy),
         other_atopy = as.logical(other_atopy),
         prick_test_result = case_when(prick_test_result == "POS" ~ TRUE,
                                       prick_test_result == "NEG" ~ FALSE,
                                       TRUE ~ NA),
         education = ifelse(education == "meidium_higher_education",
                            "medium_higher_education",
                            education),
         education = case_when(education == "primary_school" ~ 0,
                               education == "high_school" ~ 1,
                               education == "short_higher_education" ~ 2,
                               education == "medium_higher_education" ~ 3,
                               education == "long_higher_education" ~ 4),
         drinks_per_week = case_when(drinks_per_week == "0" ~ 0,
                                     drinks_per_week == "1_7" ~ 1,
                                     drinks_per_week == "7_14" ~ 2,
                                     drinks_per_week == "15_" ~ 3))

# Mann-Whitney-Wilcoxon Test
wilcox_test_d <-
  baseline_data %>% 
  select(subject, group, 
         education, skin_type_fitzpatrick_scale, drinks_per_week) %>% 
  pivot_longer(cols = c("education", "skin_type_fitzpatrick_scale", "drinks_per_week"),
               names_to = "parameter") %>% 
  group_by(parameter) %>% nest() %>% 
  mutate(p_value = map_dbl(data, function(data){
    CO <- data %>% filter(group == "CO")
    AD <- data %>% filter(group == "AD")
    wilcox.test(CO$value, AD$value, exact = F)$p.value
  }))

# t test
t_test_d <- 
  baseline_data %>% 
  select(subject, group, contains("blood"), age, bmi) %>% 
  pivot_longer(cols = !c("subject", "group"), 
               names_to = "parameter") %>% 
  group_by(parameter) %>% nest() %>% 
  mutate(p_value = map(data, function(data){
    CO <- data %>% filter(group == "CO")
    AD <- data %>% filter(group == "AD")
    t.test(CO$value, AD$value, na.rm = T)$p.value
  }))


# fisher's exact test
fisher_test_d <-
  baseline_data %>% 
  select(subject, group, gender_female, smoker, smoker_ever,
         animal, family_eczema, family_atopy, 
         other_atopy, other_diagnoses,
         prick_test_result) %>% 
  pivot_longer(cols = !c("subject", "group"),
               names_to = "parameter") %>% 
  group_by(parameter) %>% nest() %>% 
  mutate(
    AD = map_dbl(data, function(data){
      data %>% filter(group == "AD", value == TRUE) %>% nrow()
    }),
    CO = map_dbl(data, function(data){
      data %>% filter(group == "CO", value == TRUE) %>% nrow()
    }),
    p_value = map_dbl(data, function(data){
      test <- data %>% select(-subject) %>% table %>% fisher.test()
      test$p.value
      })
    )


  
clinic_summary <- 
 baseline_data %>% select(-subject) %>% group_by(group) %>% 
  summarize(no_subject = n(),
            female_percent = mean(gender == "female") * 100,
            age_mean = mean(age), age_sd = sd(age), 
            bmi_mean = mean(bmi), bmi_sd = sd(bmi), 
            blood_ige_mean = mean(blood_ige, na.rm = TRUE), blood_ige_sd = sd(blood_ige, na.rm = TRUE),
            blood_leukocyte_mean = mean(blood_leukocyte, na.rm=T), 
            blood_leukocyte_sd = sd(blood_leukocyte, na.rm=T),
            blood_lymphocyte_mean = mean(blood_lymphocyte, na.rm=T), 
            blood_lymphocyte_sd = sd(blood_lymphocyte, na.rm=T),
            blood_monocyte_mean = mean(blood_monocyte, na.rm=T),
            blood_monocyte_sd = sd(blood_monocyte, na.rm=T),
            blood_neutrophil_mean = mean(blood_neutrophil, na.rm = T),
            blood_neutrophil_sd = sd(blood_neutrophil, na.rm = T),
            blood_eosinophil_mean = mean(blood_eosinophil, na.rm = T),
            blood_eosinophil_sd = sd(blood_eosinophil, na.rm = T),
            blood_basophil_mean = mean(blood_basophil, na.rm = T),
            blood_basophil_sd = sd(blood_basophil, na.rm = T),
            easi_mean = mean(easi_total_score), easi_sd = sd(easi_total_score), 
            scorad_mean = mean(scorad, na.rm = TRUE), scorad_sd = sd(scorad, na.rm = TRUE),
            oscorad_mean = mean(scorad_objective, na.rm = TRUE), 
            oscorad_sd = sd(scorad_objective, na.rm = TRUE),
            ige_mean = mean(blood_ige, na.rm = TRUE), 
            ige_sd = sd(blood_ige, na.rm = TRUE),
            ige_median = median(blood_ige, na.rm = TRUE),
            ige_200h = sum(blood_ige > 200, na.rm = TRUE))

p_value <- 
  tibble(
    `Female%` = baseline_data %>% select(gender, group) %>% 
      table %>% fisher.test() %>% broom::tidy() %>% pull(p.value),
    `Blood_Ige > 200` = baseline_data %>% select(group, ige_200h) %>% 
      table %>% fisher.test() %>% broom::tidy() %>% pull(p.value),
    age = t.test(x = baseline_data %>% filter(group == "AD") %>% select(age),
                 y = baseline_data %>% filter(group == "CO") %>% select(age))$p.value,
    bmi = t.test(x = baseline_data %>% filter(group == "AD") %>% select(bmi),
                 y = baseline_data %>% filter(group == "CO") %>% select(bmi))$p.value,
    `blood_ige` = t.test(x = baseline_data %>% filter(group == "AD") %>% select(blood_ige),
                         y = baseline_data %>% filter(group == "CO") %>% select(blood_ige))$p.value) %>% 
  mutate_all(round, digits = 2) %>% mutate_all(as.character)

clinic_summary_t <-
  clinic_summary %>% 
  mutate(group = paste0(group, " (n=", no_subject,")"),
         `Female%` = female_percent %>% round(),
         age = paste(age_mean %>% round(1) , "±", age_sd %>% round(1)),
         bmi = paste(bmi_mean %>% round(1) , "±", bmi_sd %>% round(1)),
         blood_ige = paste(blood_ige_mean %>% round(1) , "±", blood_ige_sd %>% round(1)),
         `Blood_Ige > 200` = round(ige_200h / no_subject, 2) * 100,
         easi = paste(easi_mean %>% round(1) , "±", easi_sd %>% round(1)),
         scorad = paste(scorad_mean %>% round(1) , "±", scorad_sd %>% round(1)),
         oscorad = paste(oscorad_mean %>% round(1) , "±", oscorad_sd %>% round(1))) %>%
  select(group, `Female%`:oscorad) %>%
  column_to_rownames("group") %>% mutate_all(as.character) %>% 
  add_row(tibble_row(p_value)) %>% 
  t()

colnames(clinic_summary_t)[3] <- "p-value"
clinic_summary_t[6:8, 2:3] <- " / "
rownames(clinic_summary_t)[1] <- "Female(%)"
rownames(clinic_summary_t)[2] <- "Age"
rownames(clinic_summary_t)[3] <- "BMI"
rownames(clinic_summary_t)[4] <- "Blood IgE"
rownames(clinic_summary_t)[5] <- "Blood IgE>200(%)"
rownames(clinic_summary_t)[6] <- "EASI"
rownames(clinic_summary_t)[7] <- "SCORAD"
rownames(clinic_summary_t)[8] <- "oSCORAD"
colnames(clinic_summary_t)[2] <- "HC (n=30)"
knitr::kable(clinic_summary_t, 
             format = "html", 
             caption = "Baseline characteristics of AD and HC group") %>% 
  kableExtra::add_footnote("Age, bmi, and blood IgE were tested by t test. Gender and blood IgE > 200 (%) were tested by Fisher's exact test.")

clinic_summary_t_xlsx <- clinic_summary_t %>% as_tibble(rownames = " ")
clinic_summary_t_xlsx[9,1] <- "notes: Age, bmi, and blood IgE were tested by t test. Gender and blood IgE > 200 (%) were tested by Fisher's exact test."
# openxlsx::write.xlsx(clinic_summary_t_xlsx, 
#                      "data/supplementary/table_s1.xlsx", overwrite = T)
```


## Differential expressed genes: baseline

```{r DGE-V1, cache=TRUE}
# V1 LSvsNL --------------------
se_v1_LSvsNL <- se[, se$visit == "01" & se$skin_type %in% c("LS", "NL")]
de_v1_LSvsNL <- DESeq2::DESeqDataSet(se_v1_LSvsNL, ~ subject + skin_type)
de_v1_LSvsNL <- DESeq2::DESeq(de_v1_LSvsNL, parallel = TRUE)
de_v1_LSvsNL_LFC <- lfcShrink(de_v1_LSvsNL, coef = "skin_type_LS_vs_NL", type = "apeglm", parallel = TRUE, quiet = TRUE)
de_v1_LSvsNL_result <- de_v1_LSvsNL_LFC %>% as.data.frame() %>% tibble::rownames_to_column(var = "gene_name") %>% tibble()
de_v1_LSvsNL_result_s <- de_v1_LSvsNL_result %>% filter(padj < .05, abs(log2FoldChange) > 1)

# V1 LSvsNN --------------------
se_v1_LSvsNN <- se[, se$visit == "01" & se$skin_type %in% c("LS", "HC")]
de_v1_LSvsNN <- DESeq2::DESeqDataSet(se_v1_LSvsNN, ~ gender + skin_type) 
de_v1_LSvsNN <- DESeq2::DESeq(de_v1_LSvsNN, parallel = TRUE)
de_v1_LSvsNN_LFC <- lfcShrink(de_v1_LSvsNN, coef = "skin_type_LS_vs_HC", type = "apeglm", parallel = TRUE, quiet = TRUE)
de_v1_LSvsNN_result <- de_v1_LSvsNN_LFC %>% as.data.frame() %>% tibble::rownames_to_column(var = "gene_name") %>% tibble()
de_v1_LSvsNN_result_s <- de_v1_LSvsNN_result %>% filter(padj < .05, abs(log2FoldChange) > 1)

# V1 NLvsNN --------------------
se_v1_NLvsNN <- se[, se$visit == "01" & se$skin_type %in% c("NL", "HC")]
de_v1_NLvsNN <- DESeq2::DESeqDataSet(se_v1_NLvsNN, ~ gender + skin_type) 
de_v1_NLvsNN <- DESeq2::DESeq(de_v1_NLvsNN, parallel = TRUE)
de_v1_NLvsNN_LFC <- lfcShrink(de_v1_NLvsNN, coef = "skin_type_NL_vs_HC", type = "apeglm", parallel = TRUE, quiet = TRUE)
de_v1_NLvsNN_result <- de_v1_NLvsNN_LFC %>% as.data.frame() %>% tibble::rownames_to_column(var = "gene_name") %>% tibble()
de_v1_NLvsNN_result_s <- de_v1_NLvsNN_result %>% filter(padj < .05, abs(log2FoldChange) > 1)

# Consolidate the results -----
de_v1_c <-
  bind_rows(de_v1_LSvsNL_result_s %>% mutate(contrast = "LSvsNL"),
            de_v1_LSvsNN_result_s %>% mutate(contrast = "LSvsHC"),
            de_v1_NLvsNN_result_s %>% mutate(contrast = "NLvsHC")) %>% 
  mutate(direction = ifelse(log2FoldChange > 0, "up", "down"))
de_v1_c_s <-
  de_v1_c %>% 
  group_by(contrast) %>% 
  summarise(n_dys = n())
# No of dysregulated genes
n_de_v1_LSvsNL <- de_v1_c_s %>% filter(contrast == "LSvsNL") %>% pull(n_dys)
n_de_v1_LSvsNN <- de_v1_c_s %>% filter(contrast == "LSvsHC") %>% pull(n_dys)
n_de_v1_NLvsNN <- de_v1_c_s %>% filter(contrast == "NLvsHC") %>% pull(n_dys)
de_v1_c %>% readr::write_csv("data/de_v1_sig.csv")
de_v1_full <- list(de_v1_LSvsNL = de_v1_LSvsNL_result, 
                   de_v1_LSvsNN = de_v1_LSvsNN_result, 
                   de_v1_NLvsNN = de_v1_NLvsNN_result)
# de_v1_full %>% readr::write_rds("data/de_v1_full.rds")
```

## Differential expressed genes: anotomic area
```{r DGE space, cache=TRUE, eval=FALSE}
DGE_space <-
  tibble(
    C1 = c("LS", "NN"),
    C2 = c("NL", "NN")
  ) %>% 
  mutate(
    contrast = paste0(C1, "vs", C2),
    se_exp = map2(C1, C2, ~ se[,se$skin_type %in% c(.x, .y)]),
    design_f = ifelse(C1 == "NN" & C2 == "NN", 
                      "~ subject + visit + biopsy_area", 
                      "~ subject + skin_type + visit + biopsy_area"),
    deseq = map2(se_exp, design_f, ~ DESeqDataSet(.x, .y %>% as.formula)),
    deseq = map(deseq, ~ DESeq(.x, parallel = T)),
    res_name = map(deseq, ~ resultsNames(.x) %>% grep(pattern = "biopsy_area", ., value = T))) %>% 
  unnest(cols = res_name) %>% 
  mutate(
    res_shrink = map2(deseq, res_name, ~ lfcShrink(.x, coef = .y, type = "apeglm", parallel = T)),
    res_shrink = map(res_shrink, ~ as_tibble(.x, rownames = "gene_name"))
  )
save(DGE_space %>% select(contrast, res_shrink), "data/dge_space.rds")
```

## Differential expressed genes: time

```{r load and clean data}
se <- readr::read_rds("data/se.rds")
se <- se[,!is.na(se$visit_quarter)]
```

### Time stability (dge_tstat)

```{r dge_time_alone, eval=FALSE}
dge_tstat_design <-
  expand_grid(
  skin_type = colData(se)$skin_type %>% unique,
  t = c("visit", "visit_quarter")
  ) %>% 
  mutate(name = paste(skin_type, t, sep = "_"))
  
dge_tstat_result <-
  plyr::llply(1:nrow(dge_tstat_design), function(index){
    se <- se[,se$skin_type == dge_tstat_design$skin_type[index]]
    f <- paste("~", dge_tstat_design$t[index])
    deseq <- DESeqDataSet(se, design = as.formula(f))
    deseq <- DESeq(deseq, test = "LRT", reduced = ~ 1, 
                   parallel = T, 
                   BPPARAM = MulticoreParam(min(detectCores() - 2, 8)))
    deseq <- results(deseq)
    deseq <- as_tibble(deseq, rownames = "gene_name") %>% 
      mutate(name = dge_tstat_design$name[[index]])
  }, .progress = "text")
# saveRDS(dge_tstat_result, "data/dge_tstat_result.rds")
# dge_tstat_result <- readr::read_rds("data/dge_tstat_result.rds")

dge_tstat_result_filt <-
  map_dfr(dge_tstat_result,
           ~ filter(.x, padj < .05, abs(log2FoldChange) > 1)) 

library(enrichR)
setEnrichrSite("Enrichr")

dge_tstat_result_filt_n <- 
  dge_tstat_result_filt %>% group_by(name) %>% nest() %>% 
  mutate(gene_name = map(data, ~ pull(.x, gene_name)),
         enrichment = map(gene_name, ~ enrichr(., c("Reactome_2016"))))

dge_tstat_g <- dge_tstat_result_filt$gene_name %>% unique
dbs <- c("Human_Gene_Atlas", "ARCHS4_Tissues")
enriched_dge_tstat <- enrichr(dge_tstat_g, dbs)

map2_dfr(enriched_dge_tstat, dbs, 
         ~ .x %>% mutate(name = .y) %>% 
           filter(Adjusted.P.value < .05))
```

### Disease signature stability
```{r load dge-time}
dge_time <- 
  readr::read_rds("data/dge_time.rds")

names(dge_time)[1:2] <- 
  c("DGE_condition_specific",
    "DGE_condition_specific_non")

dge_time[[2]] %>% unnest(cols = "result") %>% 
  filter(padj < .05, abs(log2FoldChange) > 1) %>% 
  group_by(t, contrast) %>% 
  summarise(n = n())

ad_sig_stat_g <- 
  dge_time[[2]] %>% unnest(cols = "result") %>% 
    filter(padj < .05, abs(log2FoldChange) > 1) %>% filter(contrast =="LSvsNL", t =="visit_quarter") %>% pull(gene_name)

```

### Condition(LS/NL/HC)-specific change
```{r}
dge_time[[1]] %>% unnest(cols = "result") %>% 
  filter(padj < .05, abs(log2FoldChange) > 1) %>% 
  group_by(t, contrast) %>% summarise(n = n())

condition_specific_g <- 
  dge_time[[1]] %>% unnest(cols = "result") %>% 
  filter(padj < .05, abs(log2FoldChange) > 1) %>% 
  group_by(t, contrast) %>% nest() 

se[c("SAA2", "KRT27", "MUC1", "MGST1",
     "KRT71", "SHISA2", "PTGS2"),] %>% as_tibble() %>% 
    ggline(x = "visit_quarter", 
           y = "counts_scaled",
           facet.by = "feature",
           add = c("mean", "dotplot"),
           color = "skin_type", 
           palette = pca_color,
           xlab = "Quarter",
           ylab = "Counts") %>% 
    ggpar(yscale = "log10")

se[c("KRT16", "KRT18", "KRT27", 
     "KRT7", "KRT71", "KRT80"),] %>% as_tibble() %>% 
    ggline(x = "visit_quarter", 
           y = "counts_scaled",
           facet.by = "feature",
           add = c("mean", "dotplot"),
           color = "skin_type", 
           palette = pca_color,
           xlab = "Quarter",
           ylab = "Counts") %>% 
    ggpar(yscale = "log10")

```

### Time outlier figure
```{r}
time_outlier <-
  dge_tstat_result_filt %>% 
  select(gene_name, name) %>% 
  mutate(skin_type = str_extract(name, "(LS|NL|NN)"),
         skin_type = ifelse(skin_type == "NN", "HC", skin_type),
         t = str_extract(name, "(visit$|visit_quarter)")) %>% 
  select(-name) %>% 
  group_by(skin_type, t) %>% nest() %>% 
  mutate(g_n = map(data, "gene_name")) %>% 
  mutate(figure = 
           pmap(list(g_n, skin_type, t),
                       function(g_n, skin_type, t){
  plot <-
    se[g_n, se$skin_type == skin_type] %>% as_tibble() %>% 
    ggboxplot(x = t,
              y = "counts_scaled",
              facet.by = "feature",
              xlab = ifelse(t == "visit_quarter", 
                            "quarter",
                            t),
              ylab = FALSE,
              scales = "free", title = skin_type)
  }),
        save_f = pmap(list(skin_type, t, figure),
                      function(skin_type, t, figure){
          name = paste0("supplement_t_outlier_", paste(skin_type, t, sep = "_"),".png")
          ggsave(filename = paste0("figure/supplement_t_outlier", name),
                 figure, width = 16.8, height = 11.8)
        }))

```

## Biological replicates
```{r found biological replicates}
bioreplicates <-
  colData(se) %>% as_tibble() %>% 
  mutate(biological_rep_id = paste(subject, visit, skin_type)) %>%
  group_by(biological_rep_id) %>% 
  summarise(n = n()) %>% 
  filter(n == 2) %>% 
  pull(biological_rep_id)

bioreplicates_t <- 
  colData(se) %>% as_tibble() %>% 
  mutate(biological_rep_id = paste(subject, visit, skin_type)) %>% 
  filter(biological_rep_id %in% bioreplicates) %>% 
  left_join(se[c("CCL17", "CCL18", "CCL20", "CCL22", "CCL26",
                 "CXCL1", "CXCL10", "CXCL9", "FOXP3",
                 "IL10", "IL22", "IL34", "IL37", "IL4R",
                 "LORICRIN", "MMP12", "OSMR", "PI3",
                 "S100A12", "S100A7", "STAT1"),] %>% as_tibble())
replicate_g <-
  bioreplicates_t %>% 
    select(biological_rep_id, 
           subject, visit, skin_type, feature, 
           counts_scaled, replicate_ID) %>% 
  ggplot(aes(x = replicate_ID, 
             y = counts_scaled, 
             group = biological_rep_id)) + 
  geom_point(aes(color = skin_type)) + 
  facet_grid(feature ~ skin_type, scales = "free") + 
  geom_line(aes(color = skin_type), alpha = .5) + 
  geom_boxplot(aes(group = replicate_ID, fill = skin_type), alpha = .5) + 
  scale_color_manual(values = pca_color) + 
  scale_fill_manual(values = pca_color) + 
  scale_y_continuous(trans = "log2") +
  xlab("replicate") +
  theme(axis.title.y = element_blank())

ggsave("data/supplementary/supplement_replicate.png", replicate_g,
       height = 25, width = 8)
```

### correlation coefficient
```{r}
ad_sig <- 
  readr::read_csv("data/supplementary/table_s2.csv",
                  show_col_types = F) %>% 
  pull(gene_name) %>% 
  unique

bioreplicates_sig_t <- 
  colData(se) %>% as_tibble() %>% 
  mutate(biological_rep_id = paste(subject, visit, skin_type)) %>% 
  filter(biological_rep_id %in% bioreplicates) %>% 
  left_join(se[ad_sig,] %>% as_tibble())
```

## Gene set enrichment analysis
```{r dge result}
de_v1_full <- readr::read_rds("data/de_v1_full.rds")
gse107361 <- 
  readr::read_rds("data/dge_gse107361.rds") %>% # adult vs children
  mutate(dge_result = map(dge_result, unnest))
  
gse120721 <- readr::read_rds("data/dge_gse120721.rds") # LSM
gse121212 <- readr::read_rds("data/dge_gse121212.rds")
ChronicvsAcute <- readr::read_rds("data/dge_AcutevsChronic.rds")

dge_result <-
  tibble(
    project = c(rep("multi-omics",length(de_v1_full)), 
                rep("gse121212",nrow(gse121212)),
                rep("gse107361",nrow(gse107361)),
                rep("gse120721",nrow(gse120721)),
                rep("acute_chronic", nrow(ChronicvsAcute))),
    contrast = c(de_v1_full %>% names %>% str_remove("de_v1_"), 
                 gse121212$contrast, 
                 gse107361$contrast,
                 gse120721$contrast,
                 ChronicvsAcute$contrast),
    dge_result = c(de_v1_full, 
                   gse121212$res_shrink,
                   gse107361$dge_result,
                   gse120721$dge_result,
                   ChronicvsAcute$data))
```

```{r prepare gene set, cache=TRUE}
# prepare gs --------------
gs <- 
  tibble(gs_name = c("CP:BIOCARTA", 
                     "CP:KEGG", 
                     "CP:PID", 
                     "CP:REACTOME", 
                     "CP:WIKIPATHWAYS", 
                     "MIR:MIRDB", 
                     "TFT:GTRD", 
                     "GO:BP", 
                     "GO:MF")) %>% 
  mutate(gs_list = map(gs_name, function(subcat){
  gs_df <- msigdbr::msigdbr(species = "Homo sapiens", 
                            subcategory = subcat) %>% 
    group_by(gs_name) %>% tidyr::nest() %>% 
    mutate(gene_id = purrr::map(data, ~ .x %>% pull(gene_symbol))) %>% select(-data)
  gs_list <- gs_df$gene_id
  names(gs_list) <- gs_df$gs_name
  return(gs_list)
}))
```

```{r fgsea, cache=TRUE}
gsea_exp <- 
  expand.grid(contrast = dge_result$contrast,
              gs_name = gs$gs_name) %>% 
  left_join(dge_result, by = "contrast") %>% 
  left_join(gs, by = "gs_name") %>% 
  mutate(rank = map2(dge_result, gs_name,
                     function(dge_result, gs_name){
                       p_cutoff <- ifelse(gs_name %in% c("MIR:MIRDB", 
                                                         "TFT:GTRD"),
                                          1, # .05
                                          1)
                       log2fc_cutoff <- ifelse(gs_name %in% c("MIR:MIRDB",
                                                        "TFT:GTRD"),
                                               0, # 1
                                               0)
                       dge_result %>% 
                         mutate(rank = log2FoldChange) %>% 
                         filter(padj < p_cutoff, abs(log2FoldChange) > log2fc_cutoff) %>% 
                         select(gene_name, rank) %>% deframe}),
         gse_res = map2(rank, gs_list,
                            function(rank, gs_list){
                              gsa_stat <- fgsea::fgsea(pathways = gs_list, 
                                                       stats    = rank,
                                                       minSize  = 8,
                                                       maxSize  = 500, 
                                                       eps = 0,
                                                       nPermSimple = 10000,
                                                       BPPARAM = MulticoreParam(workers = core_n - 4)) %>% 
                            as_tibble()
}))

gsea_res <- gsea_exp %>% select(contrast, gs_name, project, gse_res) %>% unnest()
# gsea_res %>% saveRDS("data/gsea_res_FIVE_nocutoff.rds")
```

## microRNA
```{r}
de_v1_full <- readr::read_csv("data/de_v1_sig.csv")
microRNA <-
  de_v1_full %>% filter(gene_name %>% str_detect("MIR")) %>% 
  pull(gene_name) %>% unique()

```

### heatmap
```{r}
se_mir <- se[microRNA,]
heatmap_mir_data <- 
  se_mir
heatmap_mir_data_m <-
  scale(assay(heatmap_mir_data, 2) %>% t() %>% log1p(), 
        center = TRUE, scale = TRUE) %>% t()
sample_site_color <- 
  colData(heatmap_mir_data) %>% as_tibble() %>% pull(biopsy_area) %>% unique()
color <- RColorBrewer::brewer.pal(length(sample_site_color), "Pastel2")
names(color) <- sample_site_color
heatmap_mir_annotation <- 
  HeatmapAnnotation(
    `Tissue type` = colData(heatmap_mir_data) %>% as_tibble() %>% pull(skin_type), 
    `Anatomic region` = colData(heatmap_mir_data) %>% as_tibble() %>% pull(biopsy_area),
    col = list(`Tissue type` = pca_color,
               `Anatomic region` = color),
    # simple_anno_size = unit(1, "cm"),
    annotation_legend_param = list(`Tissue type` = list(nrow = 1, 
                                                        # grid_height = unit(2, "cm"), 
                                                        # grid_width = unit(1, "cm"), 
                                                        title_gp = gpar(fontsize = 16),
                                                        labels_gp = gpar(fontsize = 16)),
                                   `Anatomic region` = list(nrow = 1,
                                                          # grid_height = unit(2, "cm"), 
                                                          # grid_width = unit(1, "cm"), 
                                                          title_gp = gpar(fontsize = 16),
                                                          labels_gp = gpar(fontsize = 16))
                                   ))

heatmap_mir <- ComplexHeatmap::Heatmap(heatmap_mir_data_m,
                        name = "gene expression",
                        column_dend_reorder = TRUE,
                        # clustering_method_columns = "complete",
                        show_column_names = FALSE,
                        show_row_names = T,
                        show_row_dend = FALSE,
                        row_names_gp = gpar(fontsize = min(15, 800 * 6 / dim(heatmap_mir_data)[1])),
                        top_annotation = heatmap_mir_annotation,
                        heatmap_legend_param = list(
                          title_gp = gpar(fontsize = 16),
                          labels_gp = gpar(fontsize = 14)
                          ))

draw(heatmap_mir, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)

png("data/supplementary/heatmap_linc.png", 
    width = 480*6, height = 480*10, res=300)
draw(heatmap_linc, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)
dev.off()
```


## LINC 
```{r}
LINC <- 
  de_v1_full %>% filter(gene_name %>% str_detect("LINC")) %>% 
  pull(gene_name) %>% unique()

# LINC %>% write.csv("data/LINC.txt")


# l_g <- de_v1_full_t$gene_name %>% unique %>% length
# l_linc <- length(LINC)
# l_linc / l_g 

```


### heatmap
```{r}
se_linc <- se[LINC,]
heatmap_linc_data <- 
  se_linc 
# %>% keep_variable(.abundance = counts_scale, top = 50)
heatmap_linc_data_m <-
  scale(assay(heatmap_linc_data, 2) %>% t() %>% log1p(), 
        center = TRUE, scale = TRUE) %>% t()
sample_site_color <- 
  colData(heatmap_linc_data) %>% as_tibble() %>% pull(biopsy_area) %>% unique()
color <- RColorBrewer::brewer.pal(length(sample_site_color), "Pastel2")
names(color) <- sample_site_color
heatmap_linc_annotation <- 
  HeatmapAnnotation(
    `Tissue type` = colData(heatmap_linc_data) %>% as_tibble() %>% pull(skin_type), 
    `Anatomic region` = colData(heatmap_linc_data) %>% as_tibble() %>% pull(biopsy_area),
    col = list(`Tissue type` = pca_color,
               `Anatomic region` = color),
    # simple_anno_size = unit(1, "cm"),
    annotation_legend_param = list(`Tissue type` = list(nrow = 1, 
                                                        # grid_height = unit(2, "cm"), 
                                                        # grid_width = unit(1, "cm"), 
                                                        title_gp = gpar(fontsize = 16),
                                                        labels_gp = gpar(fontsize = 16)),
                                   `Anatomic region` = list(nrow = 1,
                                                          # grid_height = unit(2, "cm"), 
                                                          # grid_width = unit(1, "cm"), 
                                                          title_gp = gpar(fontsize = 16),
                                                          labels_gp = gpar(fontsize = 16))
                                   ))

heatmap_linc <- ComplexHeatmap::Heatmap(heatmap_linc_data_m,
                        name = "gene expression",
                        column_dend_reorder = TRUE,
                        # clustering_method_columns = "complete",
                        show_column_names = FALSE,
                        show_row_names = T,
                        show_row_dend = FALSE,
                        row_names_gp = gpar(fontsize = min(15, 800 * 6 / dim(heatmap_linc_data)[1])),
                        top_annotation = heatmap_linc_annotation,
                        heatmap_legend_param = list(
                          title_gp = gpar(fontsize = 16),
                          labels_gp = gpar(fontsize = 14)
                          ))

draw(heatmap_linc, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)

png("data/supplementary/heatmap_linc.png", 
    width = 480*6, height = 480*10, res=300)
draw(heatmap_linc, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)
dev.off()
```

## Disease severity change
### Figure S6
```{r}
extensive_meta <- readr::read_csv("../multiomics-ad-transcriptomics//data/RNAseq_sample_annotation(extensive).csv")
time_course_ad_subject <- 
  extensive_meta %>% filter(visit == "02", group == "AD") %>% pull(subject) %>% unique

disease_severity <- extensive_meta %>% 
  dplyr::filter(subject %in% time_course_ad_subject) %>% 
  dplyr::select(-skin_type) %>% 
  distinct() %>% 
  dplyr::select(visit, visit_quarter, subject, 
                easi_total_score, scorad_objective, scorad) %>% 
  tidyr::pivot_longer(cols = c("easi_total_score",
                               "scorad_objective",
                               "scorad"), 
                      names_to = "disease_severity") %>% 
  filter(subject != "AD_11") %>% 
  mutate(disease_severity = 
            case_when(disease_severity == "easi_total_score" ~ "EASI",
                      disease_severity == "scorad" ~ "SCORAD",
                      disease_severity == "scorad_objective" ~ "oSCORAD"),
         disease_severity = forcats::fct_relevel(disease_severity,
                                                 c("EASI", 
                                                   "SCORAD",
                                                   "oSCORAD")),
         visit = visit %>% as.character(),
         visit_quarter = visit_quarter %>% as.character())

# disease_severity_v <- 
disease_severity %>% select(-visit) %>% 
  rename(visit = visit_quarter) %>% mutate(visit_type = "quarter") %>% 
  bind_rows(disease_severity %>% select(-visit_quarter) %>% 
  mutate(visit_type = "visit") %>% 
    mutate(visit = paste0("V", visit %>% as.numeric()))) %>% 
  ggboxplot(x = "visit", 
            y = "value", 
            add = "point", 
            color = "visit", xlab = FALSE, ylab=FALSE) %>%
  facet(facet.by = c("disease_severity", "visit_type"), nrow = 3, scales = "free") %>% 
  set_palette("npg")
```

```{r}
disease_severity_natural_year <- extensive_meta %>% 
  dplyr::filter(subject %in% time_course_ad_subject) %>% 
  dplyr::select(-skin_type) %>% 
  distinct() %>% 
  mutate(year = date_visit %>% format("%Y"),
         year_quarter = paste0(year, visit_quarter)) %>% 
  dplyr::select(visit, visit_quarter, year_quarter, subject, 
                easi_total_score, scorad_objective, scorad) %>% 
  tidyr::pivot_longer(cols = c("easi_total_score",
                               "scorad_objective",
                               "scorad"), 
                      names_to = "disease_severity") %>% 
  filter(subject != "AD_11") %>% 
  mutate(disease_severity = 
            case_when(disease_severity == "easi_total_score" ~ "EASI",
                      disease_severity == "scorad" ~ "SCORAD",
                      disease_severity == "scorad_objective" ~ "oSCORAD"),
         disease_severity = forcats::fct_relevel(disease_severity,
                                                 c("EASI", 
                                                   "SCORAD",
                                                   "oSCORAD")),
         visit = visit %>% as.character(),
         visit_quarter = visit_quarter %>% as.character())

disease_severity_natural_year_g <- 
  disease_severity_natural_year %>% 
  ggplot(aes(year_quarter, value, group = subject, color = subject)) +
  geom_point() + geom_line() + facet_grid(disease_severity~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Time") +
  theme_classic() +
  theme(axis.title.y =  element_blank())

ggsave("data/supplementary/figure_s6.png", disease_severity_natural_year_g)
```

# Skin transcriptome figure

```{r initiate transcriptomics figures, echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load(tibble, dplyr, tidyr, readr, stringr, ggplot2, purrr, 
               tidybulk, tidySummarizedExperiment, 
               ComplexHeatmap, ggpubr,
               BiocParallel, Biobase, variancePartition,
               DESeq2, limma, edgeR, MuSiC, convert, upSetR,
               patchwork)
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, fig.align = 'center')
pca_color <- c("LS" = "#eb2d0c", "NL" = "#eb8b9b", "HC" = "#91cf60")
core_n <- future::availableCores()
register(MulticoreParam(ifelse(core_n <= 8, core_n - 2, core_n - 6)))
```

## Transcriptomic profile of atopic dermatitis (AD) signature

### PCA

```{r pca}
# load data
se <- readr::read_rds("data/se.rds")
colData(se) <- 
  DataFrame(
  colData(se) %>% 
    as.data.frame() %>% 
    mutate(skin_type = as.character(skin_type),
           skin_type = ifelse(skin_type == "NN", "HC", skin_type),
           skin_type = forcats::fct_relevel(skin_type, c("HC", "NL", "LS")))
  )

core_genes <- 
  readr::read_csv("data/de_v1_sig.csv", show_col_types = FALSE) %>% 
  filter(contrast == "LSvsNL") %>%
  pull(gene_name) %>% unique()

# dimension reduction
PCA_core <- se[core_genes,] %>% reduce_dimensions(method = "PCA")
PCA_core_d <- attr(PCA_core, "internals")$PCA
```

```{r pca vis, eval=FALSE}
pca3d::pca3d(PCA_core_d, group = PCA_core$skin_type, 
             col = pca_color, radius = 1.5, 
             shape = "s", 
             show.plane = FALSE)

# save figure
# rgl::snapshot3d("figure/pca3d.png", fmt="png")
# rgl::rgl.postscript("figure/pca3d.pdf", fmt="pdf")
```

```{r pca show vis, fig.cap = "pca 3d plot", dpi=300, out.width='80%'}
knitr::include_graphics("figure/pca3d.png")
```

### Heatmap


#### AD-sig
```{r AD-sig, fig.cap = "Heatmap", fig.align='center', dpi = 300, fig.height=8}
se_heatmap <- se
se_heatmap <- se_heatmap[core_genes[core_genes %in% rownames(se_heatmap)],]

heatmap_data <- 
  se_heatmap 
# %>% keep_variable(.abundance = counts_scale, top = 50)
heatmap_data_m <-
  scale(assay(heatmap_data, 2) %>% t() %>% log1p(), 
        center = TRUE, scale = TRUE) %>% t()
sample_site_color <- 
  colData(heatmap_data) %>% as_tibble() %>% pull(biopsy_area) %>% unique()
color <- RColorBrewer::brewer.pal(length(sample_site_color), "Pastel2")
names(color) <- sample_site_color
heatmap_annotation <- 
  HeatmapAnnotation(
    `Tissue type` = colData(heatmap_data) %>% as_tibble() %>% pull(skin_type), 
    `Anatomic region` = colData(heatmap_data) %>% as_tibble() %>% pull(biopsy_area),
    col = list(`Tissue type` = pca_color,
               `Anatomic region` = color),
    # simple_anno_size = unit(1, "cm"),
    annotation_legend_param = list(`Tissue type` = list(nrow = 1, 
                                                        # grid_height = unit(2, "cm"), 
                                                        # grid_width = unit(1, "cm"), 
                                                        title_gp = gpar(fontsize = 16),
                                                        labels_gp = gpar(fontsize = 16)),
                                   `Anatomic region` = list(nrow = 1,
                                                          # grid_height = unit(2, "cm"), 
                                                          # grid_width = unit(1, "cm"), 
                                                          title_gp = gpar(fontsize = 16),
                                                          labels_gp = gpar(fontsize = 16))
                                   ))

heatmap <- ComplexHeatmap::Heatmap(heatmap_data_m,
                        name = "gene expression",
                        column_dend_reorder = TRUE,
                        # clustering_method_columns = "complete",
                        show_column_names = FALSE,
                        show_row_names = FALSE,
                        show_row_dend = FALSE,
                        # row_names_gp = gpar(fontsize = min(10, 800 * 1.5 / dim(heatmap_data_m)[1])),
                        top_annotation = heatmap_annotation,
                        heatmap_legend_param = list(
                          title_gp = gpar(fontsize = 16),
                          labels_gp = gpar(fontsize = 14)
                          ))

draw(heatmap, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)

# poster 480*8.1.5 480*10*1.5
# png("figure/heatmap.png", width = 480*6, height = 480*6, res=300)
# draw(heatmap, heatmap_legend_side = "right",
#      annotation_legend_side = "top", merge_legend = FALSE)
# dev.off()
```

#### Top-100
```{r top100}
se_heatmap_top100 <- se
top100_g <- 
  de_v1_c %>% 
  mutate(absolute_lc = abs(log2FoldChange)) %>% 
  slice_max(absolute_lc, n = 100) %>% pull(gene_name)

se_heatmap_top100 <- se_heatmap_top100[top100_g,]

heatmap_data_top100 <- 
  se_heatmap_top100 
# %>% keep_variable(.abundance = counts_scale, top = 50)
heatmap_data_m_top100 <-
  scale(assay(heatmap_data_top100, 2) %>% t() %>% log1p(), 
        center = TRUE, scale = TRUE) %>% t()
sample_site_color <- 
  colData(heatmap_data_top100) %>% as_tibble() %>% pull(biopsy_area) %>% unique()
color <- RColorBrewer::brewer.pal(length(sample_site_color), "Pastel2")
names(color) <- sample_site_color
heatmap_annotation <- 
  HeatmapAnnotation(
    `Tissue type` = colData(heatmap_data_top100) %>% as_tibble() %>% pull(skin_type), 
    `Anatomic region` = colData(heatmap_data_top100) %>% as_tibble() %>% pull(biopsy_area),
    col = list(`Tissue type` = pca_color,
               `Anatomic region` = color),
    # simple_anno_size = unit(1, "cm"),
    annotation_legend_param = list(`Tissue type` = list(nrow = 1, 
                                                        # grid_height = unit(2, "cm"), 
                                                        # grid_width = unit(1, "cm"), 
                                                        title_gp = gpar(fontsize = 16),
                                                        labels_gp = gpar(fontsize = 16)),
                                   `Anatomic region` = list(nrow = 1,
                                                          # grid_height = unit(2, "cm"), 
                                                          # grid_width = unit(1, "cm"), 
                                                          title_gp = gpar(fontsize = 16),
                                                          labels_gp = gpar(fontsize = 16))
                                   ))

heatmap_top100 <- ComplexHeatmap::Heatmap(heatmap_data_m_top100,
                        name = "gene expression",
                        column_dend_reorder = TRUE,
                        # clustering_method_columns = "complete",
                        show_column_names = FALSE,
                        show_row_names = TRUE,
                        show_row_dend = FALSE,
                        row_names_gp = gpar(fontsize = 6.5),
                        top_annotation = heatmap_annotation,
                        heatmap_legend_param = list(
                          title_gp = gpar(fontsize = 16),
                          labels_gp = gpar(fontsize = 14)
                          ))

draw(heatmap_top100, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)

png("figure/heatmap_top100.png", width = 480*6, height = 480*6, res=300)
draw(heatmap_top100, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)
dev.off()

```





### Cosine similarity
```{r Cosine similarity}
# se <- readr::read_rds("data/se.rds")
group_color <- c("LS" = "#eb2d0c", "NL" = "#eb740c", "HC" = "#91cf60")
cosine_st <-
    lapply(c("LS", "NL", "HC"), function(x){
    se %>% 
      subset(select = skin_type == x) %>% 
      assay(2) %>% 
      coop::cosine() %>% 
      as.numeric()})

names(cosine_st) <- c("LS", "NL", "HC")

cosine_df <- plyr::ldply(cosine_st, tibble, .name_repair = ~ c("cos_dist"),
                       .id = "skin_type") %>% tibble
cosine_p <- 
  cosine_df %>% 
  ggpubr::ggdensity(x = "cos_dist", fill = "skin_type", 
                    palette = pca_color, xlab = "Cosine similarity",
                    alpha = .8) %>% 
  ggpubr::ggpar(legend.title = "tissue type")

cosine_p

# png("figure/cosine_p.png", width=480*10/1.4, height = 480*8/1.4, res = 600)
# cosine_p
# dev.off()
```

```{r}
lapply(cosine_st, median)
```



## Gene set enrichment analysis
```{r gsea split}
gsea_res <- 
  readr::read_rds("data/gsea_res_FIVE_nocutoff.rds") %>% 
  mutate(contrast = contrast %>% str_remove("de_v1_")) %>% 
  filter(gs_name %in% c("CP:REACTOME", "MIR:MIRDB", "TFT:GTRD", "GO:BP", "GO:MF"))

# gene set regulatory
gs_r <- 
  gsea_res %>% 
  filter(
    (gs_name %in% c("TFT:GTRD") & padj < .05 & project == "multi-omics") | 
    (pathway %>% str_detect("PID_P\\d{1,}")) & padj < .05 ) %>% pull(pathway) %>% unique()
```

```{r appendix}
gsea_res_ex_filt <- gsea_res %>% filter(padj < .05, 
                                        !contrast %>% str_detect("PSO"))

gsea_res_ex_n <- 
  gsea_res_ex_filt %>% 
  group_by(pathway) %>% 
  summarise(n = n())

gsea_res_ex_appendix_w <-
  gsea_res_ex_filt %>% mutate(contrast = paste(project, contrast)) %>% 
  select(contrast, pathway, NES) %>% pivot_wider(names_from = contrast, values_from = NES) %>% 
  left_join(gsea_res_ex_n, by = "pathway") %>% arrange(-n) %>% 
  select(pathway, 
         n,
         contains("multi-omics"), 
         contains("gse121212"), 
         contains("acute_chronic"),
         contains("gse107361"), 
         contains("gse120721"))
# saveRDS(gsea_res_ex_appendix_w, "data/gsea_appendix.rds")

gsea_res_ex_filt_w <-
  gsea_res_ex_filt %>% mutate(contrast = paste(project, contrast)) %>% 
  group_by(gs_name) %>% nest() %>% 
  mutate(data = map(data, 
                    ~ .x %>% 
                      select(contrast, pathway, NES) %>% 
                      pivot_wider(names_from = contrast, values_from = NES) %>% 
                      left_join(gsea_res_ex_n, by = "pathway") %>% 
                      arrange(-n) %>% 
                      mutate(url = paste0("https://www.gsea-msigdb.org/gsea/msigdb/cards/",
                                          pathway,
                                          ".html")) %>% 
  select(pathway,
         n,
         url,
         contains("multi-omics"), 
         contains("gse121212"), 
         contains("acute_chronic"),
         contains("gse107361"), 
         contains("gse120721")) 
  ))

gsea_res_ex_filt_p_value_w <-
  gsea_res_ex_filt %>% mutate(contrast = paste(project, contrast)) %>% 
  group_by(gs_name) %>% nest() %>% 
  mutate(data = map(data, 
                    ~ .x %>% 
                      select(contrast, pathway, padj) %>% 
                      pivot_wider(names_from = contrast, values_from = padj) %>% 
                      left_join(gsea_res_ex_n, by = "pathway") %>% 
                      arrange(-n) %>% 
                      mutate(url = paste0("https://www.gsea-msigdb.org/gsea/msigdb/cards/",
                                          pathway,
                                          ".html")) %>% 
  select(pathway,
         n,
         url,
         contains("multi-omics"), 
         contains("gse121212"), 
         contains("acute_chronic"),
         contains("gse107361"), 
         contains("gse120721")) 
  ))


gsea_xlsx <- c(gsea_res_ex_filt_w$data,
                  gsea_res_ex_filt_p_value_w$data)

names(gsea_xlsx) <- 
  c(gsea_res_ex_filt_w$gs_name %>% str_replace(":", "_") %>% str_c("_NES"),
    gsea_res_ex_filt_w$gs_name %>% str_replace(":", "_") %>% str_c("_padj"))

# gsea_xlsx %>% openxlsx::write.xlsx("data/gsea_res.xlsx", overwrite = T)
```

```{r gsea-vis}
# gene set ad related
gs_ad <- gsea_res_ex_filt %>% filter(pathway %in% c("REACTOME_CHEMOKINE_RECEPTORS_BIND_CHEMOKINES",
                                                    "REACTOME_INTERFERON_SIGNALING",
                                                    "KEGG_JAK_STAT_SIGNALING_PATHWAY",
                                                    "REACTOME_INTERLEUKIN_10_SIGNALING",
                                                    "GOBP_INFLAMMATORY_RESPONSE",
                                                    "REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING", # IL4&13
                                                    "REACTOME_INTERLEUKIN_12_FAMILY_SIGNALING", # IL12
                                                    "REACTOME_INTERLEUKIN_1_FAMILY_SIGNALING", # IL1
                                                    "REACTOME_INTERLEUKIN_10_SIGNALING",
                                                    "REACTOME_INTERLEUKIN_20_FAMILY_SIGNALING",
                                                    # "REACTOME_INTERLEUKIN_17_SIGNALING",
                                                    "GOBP_T_CELL_ACTIVATION",
                                                    "GOBP_T_CELL_PROLIFERATION",
                                                    "GOBP_KERATINOCYTE_DIFFERENTIATION",
                                                    "GOBP_NEUTRAL_LIPID_BIOSYNTHETIC_PROCESS",
                                                    "GOBP_CHRONIC_INFLAMMATORY_RESPONSE",
                                                    "GOBP_POSITIVE_REGULATION_OF_MACROPHAGE_ACTIVATION",
                                                    "GOBP_EOSINOPHIL_MIGRATION",
                                                    "GOBP_DEFENSE_RESPONSE_TO_BACTERIUM") & padj < .05
                               # pathway %>% str_detect("REACTOME_INTERLEUKIN") & padj < .05
                             ) %>% pull(pathway) %>% unique()

gsea_res_filt <-
  gsea_res %>% filter(pathway %in% c(gs_r, gs_ad)) %>% mutate(`-log10p` = -log10(padj)) %>% 
  group_by(pathway, gs_name) %>% nest() %>% 
  mutate(url = paste0("https://www.gsea-msigdb.org/gsea/msigdb/cards/",
                      pathway,
                      ".html"),
         des = map_chr(url, 
                   function(url){
                     url %>% xml2::read_html() %>% 
                       rvest::html_node(css = "tr:nth-child(3) td") %>%
                       rvest::html_text()}),
         des = ifelse(gs_name == "GO:BP", # add description
                      pathway %>% str_remove("GOBP") %>% str_replace_all("_", " ") %>% str_to_sentence(), 
                      des),
         des = ifelse(gs_name %in% c("MIR:MIRDB", "TFT:GTRD"),
                      pathway %>% str_replace("_TARGET_GENES", " target genes"),
                      des)) %>% 
  unnest() %>% 
  mutate(contrast = case_when(
           contrast == "AD-LSvsAD-NL" ~ "LSvsNL",
           contrast == "AD-LSvsCO" ~ "LSvsHC",
           contrast == "AD-NLvsCO" ~ "NLvsHC",
           contrast == "LSvsNN" ~ "LSvsHC",
           contrast == "NLvsNN" ~ "NLvsHC",
           contrast == "Adult_LSvsAdult_NL" ~ "Adult_LSvsNL",
           contrast == "Adult_NNvsChildren_NN" ~ "Adult_HCvsChildren_HC",
           contrast == "Children_LSvsChildren_NL" ~ "Children_LSvsNL",
           contrast == "LS/NL_derm" ~ "LSvsNL_dermis",
           contrast == "LS/NL_epi" ~ "LSvsNL_epidermis",
           contrast == "LS/NL_FT" ~ "LSvsNL_full tissue",
           TRUE ~ contrast)) 


gsea_ad_p <-
  gsea_res_filt %>% filter(pathway %in% gs_ad, 
                           !contrast %>% str_detect("PSO"),
                           padj < .05,
                           !contrast %in% c("Adult_LSvsAdult_NN",
                                            "Adult_NLvsAdult_NN",
                                            "Adult_NLvsAdult_NN",
                                            "Children_NLvsChildren_NN",
                                            "Children_LSvsChildren_NN",
                                            "Adult_LSvsChildren_LS",
                                            "Adult_NLvsChildren_NL",
                                            "LS/NN_derm",
                                            "LS/NN_epi",
                                            "LS/NN_FT",
                                            "NL/NN_derm",
                                            "NL/NN_FT")) %>% 
  mutate(
    des = des %>% str_replace_all("interleukin|Interleukin", "IL"),
    cat = case_when(
    pathway %in% c("PID_IL23_PATHWAY",
                   "KEGG_JAK_STAT_SIGNALING_PATHWAY",
                   "REACTOME_INTERLEUKIN_10_SIGNALING",
                   "REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING",
                   "REACTOME_INTERLEUKIN_12_FAMILY_SIGNALING",
                   "WP_TYPE_II_INTERFERON_SIGNALING_IFNG",
                   "KEGG_JAK_STAT_SIGNALING_PATHWAY") ~ "signal transduction",
    pathway %in% c("GOBP_KERATINOCYTE_DIFFERENTIATION",
                   "GOBP_NEUTRAL_LIPID_BIOSYNTHETIC_PROCESS", "REACTOME_DEFENSINS",
                   "GOBP_DEFENSE_RESPONSE_TO_BACTERIUM") ~ "skin barrier",
    pathway %in% c("KEGG_CHEMOKINE_SIGNALING_PATHWAY",
                   "KEGG_CYTOKINE_CYTOKINE_RECEPTOR_INTERACTION",
                   "GOBP_INFLAMMATORY_RESPONSE",
                   "GOBP_T_CELL_ACTIVATION",
                   "GOBP_T_CELL_PROLIFERATION",
                   "GOBP_CHRONIC_INFLAMMATORY_RESPONSE") ~ "immune response",
    TRUE ~ "signal transduction")) %>% 
  ggplot(aes(contrast, des, size = `-log10p`, color = NES)) + 
  geom_point() +
  scale_size_area(max_size = 8) + 
  scale_color_gradient2(low="blue", mid = "white", high="red") +
  theme_bw() +
  facet_grid(cat~project, scales = "free", space = "free") +
  theme(axis.title = element_blank(), axis.text.x = element_text(angle = 35, hjust = 1))

gsea_ad_p

ggsave("figure/gsea_ad.png", gsea_ad_p, width = 9.5, height = 7)
```

## Variance analysis

```{r vpall, cache=TRUE, eval=FALSE}
# se <- readr::read_rds("data/se.rds")
isexpr <- rowSums(cpm(se)>1) >= 0.5 * ncol(se)
seExpr <- se[isexpr,]
seExpr <- calcNormFactors(seExpr)
design <- model.matrix(~ skin_type, seExpr$samples)
vobj <- voom(seExpr, design)
vp_all <- 
  variancePartition::fitExtractVarPartModel(
    # scale(assay(se, 2) %>% t() %>% log1p(), 
    #   center = TRUE, scale = TRUE) %>% t(),
    vobj,
    ~ (1|sequencing_batch) + scorad + easi_total_score + 
      (1|skin_type) + (1|subject) + (1|visit_quarter) + 
      (1|gender) + (1|biopsy_area) + (1|rna_quality) + (1|visit),    
    colData(se) %>% as_tibble()
    )
# variancePartition::plotVarPart(vp_all)
```

```{r VP core gene, cache=TRUE, dpi=600, fig.width=12}
# transform data for linear modeling
# se <- readr::read_rds("data/se.rds")
de_v1_c <- readr::read_csv("data/de_v1_sig.csv")
se_core <- se[names(se) %in% (de_v1_c %>% pull(gene_name) %>% unique),
              which(se$rna_quality %in% c("high"))]
seExpr_core <- calcNormFactors(se_core)
design_core <- model.matrix(~ skin_type, seExpr_core$samples)
vobj_core <- voom(seExpr_core, design_core)


# perform VP analysis
vp_core <- variancePartition::fitExtractVarPartModel(
    vobj_core,
    ~ 
      scorad + easi_total_score +
      (1|skin_type) + (1|subject) + (1|visit_quarter) + 
      (1|gender) + (1|biopsy_area),
    colData(se_core) %>% as_tibble()
)
# vp_core %>% saveRDS("vp_core.rds")
vp_core_t <- 
  vp_core %>% as_tibble(rownames = "gene_name")

# vp_core_t %>% saveRDS("data/vp_core_t.rds")

# plot 1 - violin
vp_core_p <- vp_core
names(vp_core_p)[1] <- "anatomic region"
names(vp_core_p)[3] <- "tissue type (LS/NL/HC)"
names(vp_core_p)[4] <- "individual"
names(vp_core_p)[5] <- "quarter"
names(vp_core_p)[6] <- "SCORAD"
names(vp_core_p)[7] <- "EASI"
names(vp_core_p)[8] <- "residual"
source("R/plot.R")
vpcore_violin <-
  plotVarPart_internal(vp_core_p) + 
  theme(plot.margin = margin(.5, .5, .5, 2, "cm")) +
  ylab("Var(%) explained")

# vp_core_p %>% 
#   as_tibble(rownames = "gene_name") %>% 
#   select(gene_name, `tissue type (LS/NL/HC)`, individual, SCORAD, EASI, quarter, `anatomic region`, gender, unexplained) %>% 
#   write.csv("data/supplementary/table_s5.csv")

# plot 2 - cytokine dot plot
cytokine_vp <- 
  vp_core_t %>% 
  filter(gene_name %>% str_detect("^IL\\d{1}|TNF|EBI|IFN|OSMR")) %>% 
  arrange(-skin_type) %>% 
  pivot_longer(cols = !gene_name, names_to = "term") %>% 
  filter(term == "skin_type") %>% 
  mutate(var_explained = round(value * 100, 2))
cytokine_vp_P <- ggpubr::ggdotchart(
  cytokine_vp, x = "gene_name", y = "var_explained",
  color = "#FC4E07",
  xlab = "",
  sorting = "descending",
  rotate = TRUE, 
  add = "segments",
  ggtheme = ggpubr::theme_pubr(),
  dot.size = 4,
  ylab = "Var% explained by atopic dermatitis tissue"
)

# plot 3 - top cytokine boxplot
top_cytokine <-
  cytokine_vp %>% filter(term == "skin_type") %>% 
  arrange(-var_explained) %>% slice_head(n = 5) %>% pull(gene_name)
top_cytokine_boxplot <-
  se[top_cytokine,] %>% as_tibble() %>% 
  mutate(feature = feature %>% forcats::fct_relevel(top_cytokine)) %>% 
  ggboxplot(x = "skin_type", y = "counts_scaled", add = "jitter", 
            facet.by = "feature", xlab = FALSE,
            ylab = "counts", color = "skin_type", 
            palette = pca_color, legend.title = "",
            font.legend = c(14), nrow = 1, yscale = "log10")
  # stat_compare_means()

# consolidate 3 plots
vp_core_p <- 
  ((vpcore_violin / top_cytokine_boxplot) | cytokine_vp_P)
vp_core_p

# save the plot (Not execuate)
ggsave("figure/vp_core.png", vp_core_p, 
       width = 12 * 1.2, height = 8 * 1.2, dpi = "retina")
```

## Hair
```{r generate heatmap for krtap, cache=TRUE}
se_krtap <- 
  readr::read_rds("data/se_krtap.rds") %>% 
  mutate(skin_type = skin_type %>% as.character(),
         skin_type = ifelse(skin_type == "NN", "HC", skin_type))



KRTAP_filt_d <- 
  se_krtap %>% assay(2) %>% log1p() %>% t() %>% scale() %>% t()
sample_site_color <- 
  colData(se_krtap) %>% as_tibble() %>% pull(biopsy_area) %>% unique()
color <- RColorBrewer::brewer.pal(length(sample_site_color), "Set3")
names(color) <- sample_site_color

heatmap_annotation <- 
  HeatmapAnnotation(
    `Tissue type` = colData(se_krtap) %>% as_tibble() %>% pull(skin_type), 
    `Anatomic region` = colData(se_krtap) %>% as_tibble() %>% pull(biopsy_area),
    col = list(`Tissue type` = pca_color,
               `Anatomic region` = color),
    # simple_anno_size = unit(1, "cm"),
    annotation_legend_param = list(`Tissue type` = list(nrow = 1, 
                                                        # grid_height = unit(2, "cm"), 
                                                        # grid_width = unit(1, "cm"), 
                                                        title_gp = gpar(fontsize = 16),
                                                        labels_gp = gpar(fontsize = 16)),
                                   `Anatomic region` = list(nrow = 2,
                                                          # grid_height = unit(2, "cm"), 
                                                          # grid_width = unit(1, "cm"), 
                                                          title_gp = gpar(fontsize = 16),
                                                          labels_gp = gpar(fontsize = 16))
                                   ))
# grid_height = unit(1, "cm"), grid_width = unit(5, "mm")
                                               
heatmap <- ComplexHeatmap::Heatmap(KRTAP_filt_d,
                        name = "gene expression",
                        column_dend_reorder = TRUE,
                        # clustering_method_columns = "complete",
                        show_column_names = FALSE,
                        show_row_dend = FALSE,
                        row_names_gp = gpar(fontsize = min(12, 800 * 1.5 / dim(KRTAP_filt_d)[1])),
                        top_annotation = heatmap_annotation,
                        heatmap_legend_param = list(
                          # title_gp = gpar(fontsize = 14),
                          # labels_gp = gpar(fontsize = 12)
                          ))

draw(heatmap, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)

png("figure/heatmap_KRTAP.png", width = 480 * 1.5, height = 480 * 1.5)
draw(heatmap, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)
dev.off()

pdf("figure/heatmap_KRTAP.pdf", width = 8, height = 5)
draw(heatmap, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)
dev.off()

ggsave("figure/hemap_hair.png", heatmap_hair)
```


## Regulatory elements

```{r gsea - regulatory elements}

gsea_r_p <- 
  gsea_res_filt %>% filter(pathway %in% gs_r, 
                           !contrast %>% str_detect("PSO"),
                           padj < .05,
                           !contrast %in% c("Adult_LSvsAdult_NN",
                                            "Adult_NLvsAdult_NN",
                                            "Adult_NLvsAdult_NN",
                                            "Children_NLvsChildren_NN",
                                            "Children_LSvsChildren_NN",
                                            "Adult_LSvsChildren_LS",
                                            "Adult_NLvsChildren_NL",
                                            "LS/NN_derm",
                                            "LS/NN_epi",
                                            "LS/NN_FT",
                                            "NL/NN_derm",
                                            "NL/NN_FT")) %>% 
  ggplot(aes(contrast, des, size = `-log10p`, color = NES)) + 
  geom_point() +
  scale_size_area(max_size = 6) + 
  scale_color_gradient2(low="blue", mid = "white", high="red") +
  theme_bw() +
  facet_grid(gs_name~project, scales = "free", space = "fixed") +
  theme(axis.title = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("figure/gsea_r.png", gsea_r_p, width = 9.5, height = 4)

```

```{r vp - LINC}
topLINC <- 
  vp_core_t %>% filter(gene_name %>% str_detect("LINC|MIR")) %>% 
  mutate(group = gene_name %>% str_extract("LINC|MIR")) %>%
  group_by(group) %>% 
  slice_max(skin_type, n = 14) %>% pull(gene_name)

LINC_vp_P <- 
  vp_core_t %>% filter(gene_name %in% topLINC) %>% 
  pivot_longer(cols = !gene_name, names_to = "term") %>% 
  filter(term == "skin_type") %>% 
  mutate(group = gene_name %>% str_extract("LINC|MIR")) %>%
  mutate(var_explained = round(value * 100, 2)) %>% 
  ggpubr::ggdotchart(
  x = "gene_name", y = "var_explained",
  color = "#FC4E07",
  xlab = "",
  sorting = "descending",
  rotate = TRUE, 
  add = "segments",
  ggtheme = ggpubr::theme_pubr(),
  dot.size = 4,
  ylab = "Var% explained by atopic dermatitis tissue",
  facet.by = "group",
  nrow = 2,
  scales = "free_y"
)

LINC_vp_P


topMIR <- 
  vp_core_t %>% filter(gene_name %>% str_detect("MIR")) %>% 
  pull(gene_name)
MIR_vp_P <- 
  vp_core_t %>% filter(gene_name %in% topMIR) %>% 
  pivot_longer(cols = !gene_name, names_to = "term") %>% 
  filter(term == "skin_type") %>% 
  mutate(var_explained = round(value * 100, 2)) %>% 
  ggpubr::ggdotchart(
  x = "gene_name", y = "var_explained",
  color = "#FC4E07",
  xlab = "",
  sorting = "descending",
  rotate = TRUE, 
  add = "segments",
  ggtheme = ggpubr::theme_pubr(),
  dot.size = 4,
  ylab = "Var% explained by atopic dermatitis tissue")
```

```{r boxplot - LINC}
topLINC_boxplot <-
  se[topLINC,] %>% as_tibble() %>% 
  mutate(feature = feature %>% forcats::fct_relevel(topLINC)) %>% 
  ggboxplot(x = "skin_type", y = "counts_scaled", add = "jitter", 
            facet.by = "feature", xlab = FALSE,
            ylab = FALSE, color = "skin_type", 
            palette = pca_color, legend.title = "",
            font.legend = c(14), nrow = 2, yscale = "log10")
  # stat_compare_means()
```

```{r aggregate plot, dpi=600, fig.width=12, fig.height=8}
regulatory_p <- 
  ((gsea_r_p / LINC_vp_P) | topLINC_boxplot) + 
  plot_annotation(tag_levels = "a") & 
                  theme(plot.tag = element_text(face = "bold"))
regulatory_p

# save the plot (Not execute)
# png("figure/regulatory_p.png", width = 480*20, height= 480*12, res = 600)
# regulatory_p
# dev.off()

ggsave("figure/regulatory_p.png", regulatory_p, 
       height = 8, width = 14, dpi = "retina")
```

## Anatomic region

```{r vp - anatomic region}
anatomic_g <- 
  vp_core_t %>% slice_max(biopsy_area, n = 8) %>% pull(gene_name)
```

```{r}
se[anatomic_g,] %>% as_tibble() %>% 
  ggboxplot(x = "biopsy_area", y = "counts_scaled", facet.by = "feature", scales = "free")
```

```{r dge - anatomic}
dge_anatomic <- 
  readr::read_rds("data/dge_space.rds")

dge_anatomic_sig <-
  dge_anatomic %>% 
  mutate(DGE_space_shrink = map(DGE_space_shrink,
                                ~ .x %>% filter(padj < .05, abs(log2FoldChange) > 1)))

dge_anatomic_sig_list <-
  dge_anatomic_sig %>% 
  mutate(contrast = paste(contrast, res_name %>% str_remove("biopsy_area_"), sep = "_"),
         DGE_space_shrink = map(DGE_space_shrink, ~ .x %>% pull(gene_name)))


dge_space_upset <- 
  upset(fromList(dge_anatomic_sig_list %>% select(contrast, DGE_space_shrink) %>% deframe()), 
        nsets = 9, empty.intersections = "on", order.by = "freq")

png("figure/dge_space_upset.png", width = 480 * 10, height = 480 *6, res = 600)
dge_space_upset
dev.off()

dge_anatomic_sig_n <-
  dge_anatomic %>% 
  mutate(sig_n = map_int(DGE_space_shrink, 
                         ~ .x %>% filter(padj < .05, abs(log2FoldChange) > 1) %>% 
                           nrow()))


dge_anatomic_sig_list

# leg vs arm

dge_anatomic_sig_list %>% 
  filter(contrast %in% c("LSvsNL_leg_vs_arm", "NLvsNN_leg_vs_arm")) %>% 
  pull(DGE_space_shrink) %>% purrr::reduce(intersect)

```

```{r }
se["CKAP2LP1",] %>% 
  ggplot(aes(biopsy_area, counts_scaled)) +
  geom_boxplot() +
  scale_y_log10()
```


## Cell deconvolution
```{r MuSic, cache=TRUE}
# se <- readr::read_rds("data/se.rds")
# Construct ExpressionSet for bulk RNA-seq
se_scaled <- se
# se_scaled <- 
assay(se_scaled) <- NULL

multiomics <- 
  as(se_scaled, "ExpressionSet")

# Construct ExpressionSet for scRNA-seq
emma_guttman <- readRDS("data/ext/emma_scrna_ExpressionSet.rds")

multiomics_music <- music_prop(bulk.eset = multiomics, sc.eset = emma_guttman,
                               clusters = "cell_type", samples = "sample_name")


multiomics_results <-
  data.matrix(multiomics_music$Est.prop.weighted) %>% 
  as.data.frame() %>% rownames_to_column("BAM_ID") %>% 
  pivot_longer(!BAM_ID, names_to = "cell_type", values_to = "prop") %>% 
  left_join(colData(se_scaled) %>% as_tibble() %>% select(BAM_ID, group, subject, visit, skin_type, replicate_ID, gender, scorad, scorad_objective, easi_total_score, date_visit, rna_quality, visit_quarter, biopsy_area))

cell_type_rank <- 
  multiomics_results %>% group_by(cell_type) %>% 
  summarize(mean_prop = mean(prop)) %>% arrange(-mean_prop) %>% pull(cell_type)

exclude_low_KRT <-
  multiomics_results %>% 
  filter(cell_type == "Keratinocytes", prop < .11) %>% pull(BAM_ID)

multiomics_results <-
  multiomics_results %>% filter(!BAM_ID %in% exclude_low_KRT) %>% 
  mutate(cell_type = forcats::fct_relevel(cell_type, cell_type_rank),
         prop = prop * 100)

deconvolution_vis_group <- 
  multiomics_results %>% 
  ggplot(aes(skin_type, prop, color = skin_type)) +
  geom_jitter(width = .1) +
  geom_boxplot(alpha = .4) +
  facet_wrap(~cell_type, scales = "free") +
  theme_classic() +
  ggpubr::color_palette("jco")

deconvolution_vis_group
```

### Mean bar plot
```{r mean bar}
multiomics_results %>% 
  group_by(skin_type, cell_type) %>% 
  summarise(mean = mean(prop)) %>% 
  ggbarplot("skin_type", "mean", fill = "cell_type",
            xlab = "Tissue type", ylab = "Proportion(%)", palette = "npg") %>% 
    ggpar(legend = "bottom", 
        legend.title = "Cell type",
        font.legend = 7, 
        font.tickslab = 6)
```

```{r appendix, eval=FALSE}
multiomics_results_sample <- 
  multiomics_results %>%
  mutate(plot_name = paste(subject, visit, skin_type, replicate_ID, sep = "_"))

multiomics_results_sample_count <-
  multiomics_results_sample$plot_name %>% table

multiomics_results_sample <-
  multiomics_results_sample %>% 
  filter(plot_name %in% names(which(multiomics_results_sample_count == 10)))

multiomics_results_vis_sample <- 
  multiomics_results_sample %>%  # filter(subject %in% c("AD_16", "CO_33")) %>% 
  arrange(plot_name) %>% 
  ggbarplot(x = "plot_name", y = "prop", fill = "cell_type", 
            xlab = "Sample", ylab = "Proportion(%)", palette = "npg") %>% 
  facet(facet.by = "subject", scales = "free") %>% 
  ggpar(xtickslab.rt = 90, font.tickslab = 6)

# pdf("figure/deconvolution_sample.pdf", height = 16.5 * 1.5, width = 11.7)
# multiomics_results_vis_sample
# dev.off()
```

### Statistics
```{r statisticcs}
MuSiC_matrix <-
  data.matrix(multiomics_music$Est.prop.weighted)

ALT <- # addictive log-ratio transformation
  MuSiC_matrix %>% 
  as_tibble(rownames = "BAM_ID") %>% 
  # filter(Keratinocytes > .11) %>% 
  mutate(across(!BAM_ID, ~ ifelse(.x == 0, NA, .x)),
         across(!c("BAM_ID", "Melanocytes"), 
                ~ log2(.x / Melanocytes)))  %>% 
  left_join(
    colData(se_scaled) %>% as_tibble() %>% 
      select(BAM_ID, group, subject, visit, 
             skin_type, replicate_ID, gender, 
             scorad, scorad_objective, easi_total_score, 
             date_visit, rna_quality, visit_quarter, biopsy_area)) %>% 
  rename(T_cells = `T-cells`)

C_v <- MuSiC_matrix %>% colMeans() # column mean vector
C_m <- # column mean matrix
  rep(C_v, nrow(MuSiC_matrix)) %>% matrix(nrow = nrow(MuSiC_matrix), byrow = T) 

N_m <- 
  log2(data.matrix(multiomics_music$Est.prop.weighted) / C_m)

CLT <- # centred log-ratio transformation
  N_m %>% 
  as_tibble(rownames = "BAM_ID") %>% 
  # filter(Keratinocytes > .11) %>% 
  mutate(across(!BAM_ID, ~ ifelse(.x == -Inf, NA, .x)))  %>% 
  left_join(
    colData(se_scaled) %>% as_tibble() %>% 
      select(BAM_ID, group, subject, visit, 
             skin_type, replicate_ID, gender, 
             scorad, scorad_objective, easi_total_score, 
             date_visit, rna_quality, visit_quarter, biopsy_area)) %>% 
  rename(T_cells = `T-cells`)

library(lme4)
library(lmerTest)
library(broom.mixed)



# CLT
cell_type_n <- c(colnames(CLT)[2:11])

lmm_test <- 
  function(index, data){
    f <- paste(cell_type_n[index], "~", "skin_type", "+",
               "(1|subject)", "+", "visit_quarter", "+",
               "biopsy_area")
    lmm_nonpaired <-
      lmer(f %>% as.formula(), data) %>% tidy() %>%
      filter(str_detect(term, "skin_type")) %>%
      mutate(term = paste(str_remove(term, "skin_type"), "vs HC"))
         
    lmm_paired <-
      lmer(f %>% as.formula(), 
           data %>%
             filter(skin_type %in% c("LS", "NL"))) %>%
      tidy()  %>%
      filter(str_detect(term, "skin_type")) %>%
      mutate(term = paste(str_remove(term, "skin_type"), "vs NL"))

    lmm_t <- bind_rows(lmm_nonpaired,
                       lmm_paired) %>%
      mutate(cell_type = cell_type_n[index])
       }

ALT_m <- 
  lapply(seq_along(cell_type_n), lmm_test, data = ALT)
CLT_m <- 
  lapply(seq_along(cell_type_n), lmm_test, data = CLT)


ALT_p <- 
  ALT_m %>% map_dfr(~ .x) %>% 
  select(term, p.value, cell_type) %>% 
  mutate(p.value = p.value %>% round(2)) %>% 
  pivot_wider(names_from = term, values_from = p.value)

ALT_estimate <-
  ALT_m %>% map_dfr(~ .x) %>% 
  select(term, estimate, cell_type) %>% 
  mutate(estimate = estimate %>% round(2)) %>% 
  pivot_wider(names_from = term, values_from = estimate)

CLT_p <- 
  CLT_m %>% map_dfr(~ .x) %>% 
  select(term, p.value, cell_type) %>% 
  mutate(p.value = p.value %>% round(2)) %>% 
  pivot_wider(names_from = term, values_from = p.value)

CLT_estimate <-
  CLT_m %>% map_dfr(~ .x) %>% 
  select(term, estimate, cell_type) %>% 
  mutate(estimate = estimate %>% round(2)) %>% 
  pivot_wider(names_from = term, values_from = estimate)

ALT_p %>% 
  write_csv("data/_TMP/cell_deconvolution_p.csv")
ALT_estimate %>% 
  write_csv("data/_TMP/cell_deconvolution_estimate.csv")
```

### Diversity measure
```{r diversity measure}
library(tabula)
library(folio) # Datasets
library(magrittr)

shannon <- 
  (data.matrix(multiomics_music$Est.prop.weighted) * 100) %>% 
  vegan::diversity()

diversity <-
  colData(se_scaled) %>% as_tibble() %>% 
  select(BAM_ID, group, subject, visit, 
         skin_type, replicate_ID, gender, 
         scorad, scorad_objective, easi_total_score, 
         date_visit, rna_quality, 
         visit_quarter, biopsy_area) %>% 
  mutate(shannon = shannon)

diversity_LSvsNL_lmm <- 
  lmer(shannon ~ 
       skin_type + (1|subject) + biopsy_area, 
       diversity %>% filter(skin_type %in% c("LS", "NL"))) %>% 
  tidy() %>% 
  filter(term %>% str_detect("skin_type"))

diversity_LS_NLvsHC_lmm <- 
  lmer(shannon ~ 
       skin_type + (1|subject) + 
         (1|visit_quarter) + biopsy_area, 
       diversity) %>% 
  tidy() %>% 
  filter(term %>% str_detect("skin_type"))

```

```{r dominance and evenness}
dominance <- 
  (data.matrix(multiomics_music$Est.prop.weighted) * 100) %>% 
  as_count() %>% 
  index_heterogeneity(method = "simpson")

evenness <-
  (data.matrix(multiomics_music$Est.prop.weighted) * 100) %>% 
  as_count() %>% 
  index_evenness()

similarity <-
  (data.matrix(multiomics_music$Est.prop.weighted) * 100) %>% 
  as_count() %>% 
  similarity(method = "bray")
```

### Correlation of Schwaan cells and EASI itchy
```{r}
extensive_meta <- 
  readr::read_csv("../multiomics-ad-transcriptomics/data/RNAseq_sample_annotation(extensive).csv", show_col_types = F)

ALT_scorad_t <- 
  ALT %>% 
  left_join(extensive_meta %>% 
              select(BAM_ID, contains("scorad"), -scorad, -scorad_objective) %>% 
              mutate(across(!BAM_ID, ~ as.numeric(.x))),
            by = "BAM_ID") %>% 
  filter(skin_type == c("LS"))  %>% 
  column_to_rownames("BAM_ID")

ALT_scorad_m <-
  
  
cor(ALT_scorad_t)


ALT_scorad_test <-
  expand_grid(
    cell_type = colnames(ALT_scorad_t)[2:11],
    score_type = colnames(ALT_scorad_t) %>% grep("scorad", ., value=T)
  ) %>% 
  filter(cell_type != "Melanocytes") %>% 
  mutate(test = map2(cell_type, score_type, 
                    function(cell_type, score_type){
    x = ALT_scorad_t %>% pull(!! cell_type)
    #                   cor <-
    #   cor(x = ALT_scorad_t$cell_type,
    #       y = ALT_scorad_t$score_type,
    #       use = "complete.obs", method = "spearman")
    # return(cor)
  }))

ALT_itchy_t %>% 
  ggplot(aes(scorad_lichenification, Neuron_and_Schwann_cells)) +
  geom_point() + geom_smooth(method = "lm")

cor(x = ALT_itchy_t$scorad.x, 
    y = ALT_itchy_t$Neuron_and_Schwann_cells, 
    use = "complete.obs", method = "spearman")

cor(x = ALT_itchy_t$scorad_pruritus_vas_0_10, 
    y = ALT_itchy_t$Neuron_and_Schwann_cells, 
    use = "complete.obs", method = "spearman")

cor(x = ALT_itchy_t$scorad_sleep_loss_vas_0_10, 
    y = ALT_itchy_t$Neuron_and_Schwann_cells, 
    use = "complete.obs", method = "spearman")

cor(x = ALT_itchy_t$scorad_lichenification, 
    y = ALT_itchy_t$Neuron_and_Schwann_cells, 
    use = "complete.obs", method = "spearman")

```



<!-- ## IL34 and IL37 -->
<!-- ```{r network} -->
<!-- library(igraph) -->
<!-- cytokine_df <-  -->
<!--   tibble( -->
<!--   cytosig_f = list.files("data/cytosig", full.names = T)) %>%  -->
<!--   mutate(cytokine = cytosig_f %>% basename() %>% str_remove(".csv"), -->
<!--          data = map(cytosig_f, ~ readr::read_csv(.x, show_col_types = FALSE))) %>%  -->
<!--   unnest(cols = c(data)) %>%  -->
<!--   dplyr::select(-cytosig_f,  -->
<!--                 from = ID, -->
<!--                 to = cytokine) -->

<!-- cytokine_igraph <-   -->
<!--   igraph::graph_from_data_frame( -->
<!--     cytokine_df) -->

<!-- par(mar = c(0,0,0,0)) -->
<!-- igraph::plot.igraph(cytokine_igraph,  -->
<!--                     edge.arrow.size = .2, -->
<!--                     edge.size = 100, -->
<!--                     edge.width = 5, -->
<!--                     vertex.size = 50, -->
<!--                     vertex.shape = "rectangle") -->

<!-- library(tidygraph) -->
<!-- library(ggraph) -->
<!-- tbl_graph(edges = cytokine_df, directed = T) %>%  -->
<!--   activate(edges) %>%  -->
<!--   ggraph(layout = "graphopt") +  -->
<!--   geom_edge_link( -->
<!--     aes(start_cap = label_rect(node1.name), -->
<!--         end_cap = label_rect(node2.name)), -->
<!--     arrow = arrow(length = unit(2, "mm")) -->
<!--     ) +  -->
<!--   geom_node_text(aes(label = name)) + -->
<!--   theme_graph()  -->
<!-- ``` -->

<!-- ```{r correlation coefficient} -->
<!-- cor <-  -->
<!--   se %>% assay(2) %>% t() %>% cor(method = "spearman") -->

<!-- cor_IL3437 <-  -->
<!--   cor[,c("IL34", "IL37")] %>%  -->
<!--   as_tibble(rownames = "gene_name") %>%  -->
<!--   filter(abs(IL34) > .5 | abs(IL37) > .5) -->
<!-- ``` -->


# Skin Transcriptome in Time and Space

## Abstract

## Introduction

## Results

```{r load package, echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load(tibble, dplyr, tidyr, readr, stringr, ggplot2, purrr, 
               tidybulk, tidySummarizedExperiment, 
               ComplexHeatmap, ggpubr,
               BiocParallel, Biobase, variancePartition,
               DESeq2, limma, edgeR, MuSiC, convert, 
               patchwork)
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
pca_color <- c("LS" = "#eb2d0c", "NL" = "#eb740c", "HC" = "#91cf60")
core_n <- future::availableCores()
register(MulticoreParam(ifelse(core_n <= 8, core_n - 2, core_n -6)))
```

```{r load data}
clinical_records <- 
  readr::read_csv("../multiomics-ad-transcriptomics/data/LEO-AD-metadata.csv") %>% 
  mutate(id = id %>% str_replace("-", "_"),
         JOIN_ID = paste(id, paste0("0",visit_no), sep="_"))
se <- readr::read_rds("data/se.rds")
se_krtap <- readr::read_rds("data/se_krtap.rds")
```

```{r baseline characteristics}
baseline_disease_severity <- 
  clinical_records %>% filter(visit_no == 1, group == "AD") %>% 
  summarise(mean_scorad = mean(scorad, na.rm = TRUE) %>% round(1),
            mean_easi = mean(easi_total_score) %>% round(2))
```

```{r follow-up subjects}
follow_up <- 
  clinical_records %>% filter(visit_no != 1) %>% 
  group_by(group) %>% 
  select(id, group) %>% 
  distinct() %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = group, values_from = n)
```


### Baseline characteristics of patients with mild to moderate AD

The atopic dermatitis (AD) group were characterized by mild to moderate disease severity, with mean eczema area and severity index (EASI) `r baseline_disease_severity$mean_easi` and mean SCORing Atopic Dermatitis (SCORAD) `r baseline_disease_severity$mean_scorad`. At the baseline, the AD and healthy control (HC) group showed no statistical difference in gender, age, BMI, and total blood IgE (Table: \@ref(tab:baseline-statistics-table)). Individual data points were reported in the supplementary table \@ref(tab:individual-data-table).


### RNA quality outliers and Data curation
We performed transcriptomic profiling on 401 skin biopsies collected from lesional and non-lesional skin of 30 AD patients and site-matched skin from 30 healthy subjects. From each subject, biological replicates were obtained from different skin sites. 
For `r follow_up$AD` AD and `r follow_up$CO` healthy participants, the sampling was repeated at five subsequent visits every two months for up to one year.
After data curation and cleaning (details in Data QC and curation), 339 samples were left for further analysis.


### Transcriptome architecture and components of AD

```{r PCA}
PCA <- 
  se %>% 
  reduce_dimensions(method = "PCA", top = 350)
```

```{r PCA 3d, eval=FALSE}
attr(PCA, "internals")$PCA %>% 
  pca3d::pca3d(group = PCA$skin_type, col = pca_color, radius = 1.5, 
               shape = "s", 
               show.plane = FALSE)
# rgl::snapshot3d("figure/pca3d.png", fmt="png")
# rgl::rgl.postscript("figure/pca3d.pdf", fmt="pdf")
```

```{r PCA-3d-plot, fig.cap = "pca 3d plot", dpi=300, out.width='80%'}
knitr::include_graphics("figure/pca3d.png")
```

```{r cleaning}
rm(list = ls()[!ls() %in% c("se", "se_krtap", "pca_color")])
```

We obtained `r ncol(se)` skin transcriptomes after data cleaning. The top three principal components could separate the different tissue types (fig-\@ref(fig:PCA-3d-plot)). The heatmap showed AD lesional skins (LS) can be separated from AD non-lesional skins (NL) and healthy control skins (HC), but, NL and HC can't be separated (fig-\@ref(fig:heatmap-top-50)). LS tissues showed higher heterogeneity than NL and HC tissues (fig-\@ref(fig:distance)).

```{r heatmap-top-50, fig.cap = "Heatmap", fig.align='center', dpi = 300, fig.height=8}
se_heatmap <- se
core_genes <- 
  tibble(gene_name = readr::read_csv("data/de_v1_sig.csv") %>% 
  filter(contrast == "LSvsNL") %>% pull(gene_name)) %>% 
  pull(gene_name)
se_heatmap <- se_heatmap[core_genes[core_genes %in% rownames(se_heatmap)],]
heatmap_data <- 
  se_heatmap %>% 
  keep_variable(.abundance = counts_scale,
                top = 50)
heatmap_data_m <-
  scale(assay(heatmap_data, 2) %>% t() %>% log1p(), 
        center = TRUE, scale = TRUE) %>% t()
sample_site_color <- 
  colData(heatmap_data) %>% as_tibble() %>% pull(biopsy_area) %>% unique()
color <- RColorBrewer::brewer.pal(length(sample_site_color), "Pastel2")
names(color) <- sample_site_color
heatmap_annotation <- 
  HeatmapAnnotation(
    `Tissue type` = colData(heatmap_data) %>% as_tibble() %>% pull(skin_type), 
    `Sampling site` = colData(heatmap_data) %>% as_tibble() %>% pull(biopsy_area),
    col = list(`Tissue type` = pca_color,
               `Sampling site` = color),
    # simple_anno_size = unit(1, "cm"),
    annotation_legend_param = list(`Tissue type` = list(nrow = 1, 
                                                        # grid_height = unit(2, "cm"), 
                                                        # grid_width = unit(1, "cm"), 
                                                        # title_gp = gpar(fontsize = 16),
                                                        labels_gp = gpar(fontsize = 9)),
                                   `Sampling site` = list(nrow = 1,
                                                          # grid_height = unit(2, "cm"), 
                                                          # grid_width = unit(1, "cm"), 
                                                          # title_gp = gpar(fontsize = 16),
                                                          labels_gp = gpar(fontsize = 9))
                                   ))

heatmap <- ComplexHeatmap::Heatmap(heatmap_data_m,
                        name = "gene expression",
                        column_dend_reorder = TRUE,
                        # clustering_method_columns = "complete",
                        show_column_names = FALSE,
                        show_row_dend = FALSE,
                        row_names_gp = gpar(fontsize = min(10, 800 * 1.5 / dim(heatmap_data_m)[1])),
                        top_annotation = heatmap_annotation,
                        heatmap_legend_param = list(
                          title_gp = gpar(fontsize = 14),
                          labels_gp = gpar(fontsize = 12)
                          ))

draw(heatmap, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)

# poster 480*8.1.5 480*10*1.5
# png("figure/heatmap.png", width = 480*8, height = 480*10, res=300)
# draw(heatmap, heatmap_legend_side = "right",
#      annotation_legend_side = "top", merge_legend = FALSE)
# dev.off()
```


Differential gene expression analysis generated AD disease signature which consists of `r knitr::load_cache("DGE-V1", "n_de_v1_LSvsNL")` (LS vs NL), `r knitr::load_cache("DGE-V1", "n_de_v1_LSvsNN")` (LS vs HC), and `r knitr::load_cache("DGE-V1", "n_de_v1_NLvsNN")` (NL vs HC) differentially expressed genes (\@ref(ad-dge-v1)).

Gene set enrichment analysis (GSEA) revealed that the skin transcriptome was enriched for cytokine and chemokine mediated inflammation, abnormal skin differentiation and barrier pertubation. We also identified enrichment of transcription factor targets and microRNA targets, including TP73, MAML1 (related with NOTCH signaling), PSMB5, TRIP13, MIR6768_5P, MIR6833_3P, and MIR6873_3P targets ((Table: \@ref(tab:gsea-regulatory))).

## Variance analysis

### Disease
IL37 was the best explained cytokine family gene. IL37 showed a decrease trend in HC \> NL \> LS. We also observed a few long noncoding RNA (lincRNA) with high variance can be explained by AD (Fig 2).

### Individual


### Time Effect plays a minor role in transcriptome variation

Likelihood Ratio Test (LRT) results showed no genes reacted in the condition-specific manner over time, compared to baseline samples.

I first fit a `full model` (`~ subject + time + tissue_type + tissue_type * time`), then a `reduced model` (`~ subject + time + tissue_type`) by imposing `tissue_type * time` as the constraint.

### Hair variance

```{r generate heatmap for krtap, eval=FALSE}
KRTAP_filt_d <- 
  se_krtap %>% assay(2) %>% log1p() %>% t() %>% scale() %>% t()

sample_site_color <- 
  colData(se_krtap) %>% as_tibble() %>% pull(biopsy_area) %>% unique()

color <- RColorBrewer::brewer.pal(length(sample_site_color), "Set3")
names(color) <- sample_site_color

heatmap_annotation <- 
  HeatmapAnnotation(
    `Tissue type` = colData(se_krtap) %>% as_tibble() %>% pull(skin_type), 
    `Sampling site` = colData(se_krtap) %>% as_tibble() %>% pull(biopsy_area),
    col = list(`Tissue type` = pca_color,
               `Sampling site` = color),
    # simple_anno_size = unit(1, "cm"),
    annotation_legend_param = list(`Tissue type` = list(nrow = 1), 
                                                        # grid_height = unit(2, "cm"), 
                                                        # grid_width = unit(1, "cm"), 
                                                        # title_gp = gpar(fontsize = 16),
                                                        # labels_gp = gpar(fontsize = 16)),
                                   `Sampling site` = list(nrow = 2) 
                                                          # grid_height = unit(2, "cm"), 
                                                          # grid_width = unit(1, "cm"), 
                                                          # title_gp = gpar(fontsize = 16),
                                                          # labels_gp = gpar(fontsize = 16))
                                   ))

# grid_height = unit(1, "cm"), grid_width = unit(5, "mm")
                                               
heatmap <- ComplexHeatmap::Heatmap(KRTAP_filt_d,
                        name = "gene expression",
                        column_dend_reorder = TRUE,
                        # clustering_method_columns = "complete",
                        show_column_names = FALSE,
                        show_row_dend = FALSE,
                        row_names_gp = gpar(fontsize = min(12, 800 * 1.5 / dim(KRTAP_filt_d)[1])),
                        top_annotation = heatmap_annotation,
                        heatmap_legend_param = list(
                          # title_gp = gpar(fontsize = 14),
                          # labels_gp = gpar(fontsize = 12)
                          ))

draw(heatmap, heatmap_legend_side = "right",
     annotation_legend_side = "top", merge_legend = FALSE)


# png("figure/heatmap_KRTAP.png", width = 480*4.5, height = 480*3, res=300)
# draw(heatmap, heatmap_legend_side = "right",
#      annotation_legend_side = "top", merge_legend = FALSE)
# dev.off()
```

```{r eval=FALSE}
psych::pairs.panels(se_krtap %>% assay(2) %>% log1p() %>% t())
```

## Space effect

### Variance Partition

```{r vp_biopsy_area, cache=TRUE}
se_space <- se
se_space_500 <- se_space %>% keep_variable()
vp_space_500 <- variancePartition::fitExtractVarPartModel(
    assay(se_space_500, 2), 
    ~ (1|skin_type) + (1|subject) + (1|visit) + (1|gender) + (1|biopsy_area), 
    colData(se_space_500) %>% as_tibble()
    )
# readr::write_rds(se_space_500, "data/se_space_500.rds")
# readr::write_rds(vp_space_500, "data/vp_space_500.rds")
```

```{r vp_biopsy_area_vis}
variancePartition::plotVarPart(vp_space_500)
```

```{r}
top10_space_g <- 
  vp_space_500 %>% as_data_frame() %>% 
  mutate(gene_name = se_space_500 %>% rownames()) %>% 
  slice_max(biopsy_area, n = 10) %>% pull(gene_name)
```

```{r}
top10_space <- se_space_500 %>% filter(feature %in% top10_space_g)
top10_space %>% 
  ggplot(aes(biopsy_area, counts_scaled)) + geom_point() + geom_boxplot() +
  facet_wrap(~feature, scales = "free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



#### Bioreplicate

```{r bioreplicate}

```

## Cell Type Deconvolution

```{r vp - linc genes, dpi=600, fig.height=8}
# LINC dotplot
linc_vp <- 
  vp_core_t %>% 
  filter(gene_name %>% str_detect("^LINC")) %>% 
  arrange(-skin_type) %>% 
  pivot_longer(cols = !gene_name, names_to = "term") %>% 
  filter(term == "skin_type") %>% 
  mutate(var_explained = round(value * 100, 2)) %>% 
  slice_max(order_by = var_explained, n = 15)
linc_vp_P <- 
  ggpubr::ggdotchart(
  linc_vp, x = "gene_name", y = "var_explained",
  color = "#FC4E07",
  xlab = "",
  sorting = "descending",
  rotate = TRUE, 
  add = "segments",
  ggtheme = ggpubr::theme_pubr(),
  dot.size = 4,
  ylab = "Var% explained by atopic dermatitis tissue"
)

# LINC boxplot
top_linc <- linc_vp %>% pull(gene_name) %>% head(5)
top_linc_boxplot <-
  se[top_linc,] %>% as_tibble() %>% 
  mutate(feature = feature %>% forcats::fct_relevel(top_linc)) %>% 
  ggboxplot(x = "skin_type", y = "counts_scaled", add = "jitter", 
            facet.by = "feature", xlab = FALSE,
            ylab = FALSE, color = "skin_type", 
            palette = pca_color, legend.title = "",
            font.legend = c(14), nrow = 1, yscale = "log10") +
  stat_compare_means()

# aggregate
linc_vp_P / top_linc_boxplot
```

```{r disease severity}
top_scorad_g <- vp_core_t %>% slice_max(scorad, n = 10) %>% pull(gene_name)

# top_scorad_x <- 
  se_core[top_scorad_g, ] %>% 
  ggplot(aes(scorad, counts_scaled)) + geom_point() +
    facet_wrap("feature")
```


```{r analyze individual factor, eval=FALSE}
vp_core_t %>% 
  filter(skin_type > .05, subject > .05) %>% 
  mutate(skin_type_subject_ratio = skin_type / (subject + .01)) %>% 
  arrange(skin_type_subject_ratio)
```

```{r boxplot - individual, eval=FALSE}
boxplot_individual_d <- se %>% 
  filter(feature %in% c("DOK7", "PSG5", "IGHA2", "PDZD7", "IL34"))

boxplot_individual_p <-
  boxplot_individual_d %>% as_tibble() %>% 
  ggboxplot(x = "skin_type", y = "counts_scaled", add = "jitter", 
            facet.by = "feature", scale = "free", xlab = FALSE,
            ylab = FALSE, color = "skin_type", 
            palette = pca_color, legend.title = "",
            font.legend = c(14))

boxplot_individual_p
```

```{r eval=FALSE}
vp_container <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Gene name'),
      th(colspan = 3, 'log2 Fold Change'),
      th(colspan = 3, 'Adjusted p-value'),
      th(rowspan = 2, 'Var% explained by AD tissue type')
    ),
    tr(
      lapply(rep(c('LSvsNL', 'LSvsNN', "NLvsNN"), 2), th)
    )
  )
))


datatable(vp_core, 
          colnames = c("gene name", "LSvsNL", "LSvsNN", "NLvsNN", "LSvsNL", "LSvsNN", "NLvsNN", "Var% explained by AD tissue type"), 
          container = vp_container, rownames = FALSE,
          options = list(pageLength = 20)) %>% 
  formatRound(vp_core %>% colnames %>% str_extract("log2FoldChange_\\w{6}") %>% purrr::discard(is.na)) %>% 
  formatSignif(vp_core %>% colnames %>% str_extract("padj_\\w{6}") %>% purrr::discard(is.na), digits = 3) %>% 
  formatPercentage("var_explained", 2)
```

# Transcriptome appendix
```{r setup-transcriptome-appendix, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
library(dplyr)
library(tibble)
library(tidyr)
library(SummarizedExperiment)
library(DT)
library(stringr)
library(ggpubr)
pca_color <- c("LS" = "#eb2d0c", "NL" = "#eb8b9b", "HC" = "#91cf60")
```


## Table S2 - individual data table
```{r individual-data-table}
individual_data <- 
  baseline_data %>% arrange(subject) %>% select(-ige_200_h) %>% 
  mutate(age = age %>% round,
         bmi = bmi %>% round(1))
colnames(individual_data)[3] <- "BMI"
colnames(individual_data)[4] <- "blood_IgE"
colnames(individual_data)[7] <- "EASI"
colnames(individual_data)[8] <- "SCORAD"
colnames(individual_data)[9] <- "oSCORAD"
knitr::kable(individual_data, caption = "Baseline statistics of individual subjects")
openxlsx::write.xlsx(individual_data, 
                     "data/supplementary/table_s2.xlsx", overwrite = T)
```

## Space
```{r load dge object}
dge_space <- readr::read_rds("data/dge_space.rds")
dge_space_filt <- 
  dge_space %>% unnest() %>% filter(padj < .05, abs(log2FoldChange) > 1)
readr::write_csv(dge_space_filt, "data/supplementary/dge_space.csv")
```


## Tissue type heterogenity
```{r distance, cache=TRUE, fig.cap="Cosine distance of three tissue types"}
se <- readr::read_rds("data/se.rds")
group_color <- c("LS" = "#eb2d0c", "NL" = "#eb740c", "NN" = "#91cf60")
cosine_st <-
    lapply(c("LS", "NL", "NN"), function(x){
    se %>% 
      subset(select = skin_type == x) %>% 
      assay(2) %>% 
      coop::cosine() %>% 
      as.numeric()})

names(cosine_st) <- c("LS", "NL", "NN")

cosine_df <- plyr::ldply(cosine_st, tibble, .name_repair = ~ c("cos_dist"),
                       .id = "skin_type") %>% tibble

cosine_df %>% 
  ggpubr::ggdensity(x = "cos_dist", fill = "skin_type", 
                    palette = group_color, xlab = "Cosine similarity") %>% 
  ggpubr::ggpar(legend.title = "tissue type")
```

## Visit 1: differentially expressed genes {#ad-dge-v1}
```{r ad-dge-v1}
ad_de_v1 <- readr::read_csv("data/de_v1_sig.csv") %>% select(-direction)

de_v1_c_d <- ad_de_v1 %>% 
  select(gene_name, log2FoldChange, padj, contrast) %>% 
  pivot_wider(names_from = contrast, values_from = c("log2FoldChange", "padj")) %>% 
  arrange(-log2FoldChange_LSvsNL)

t_container <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Gene name'),
      th(colspan = 3, 'log2 Fold Change'),
      th(colspan = 3, 'Adjusted p-value')
    ),
    tr(
      lapply(rep(c('LSvsNL', 'LSvsNN', "NLvsNN"), 2), th)
    )
  )
))
  
datatable(de_v1_c_d, 
          colnames = c("gene name", "LSvsNL", "LSvsNN", "NLvsNN", "LSvsNL", "LSvsNN", "NLvsNN"), container = t_container, rownames = FALSE,
          options = list(pageLength = 20)) %>% 
  formatRound(de_v1_c_d %>% colnames %>% str_extract("log2FoldChange_\\w{6}") %>% purrr::discard(is.na)) %>% 
  formatSignif(de_v1_c_d %>% colnames %>% str_extract("padj_\\w{6}") %>% purrr::discard(is.na), digits = 3)
```

## Visit 1: gene set enrichment analysis
```{r load gsea results}
gse <- readr::read_rds("data/gse_res.rds")
names(gse)
```

### Enrichment of AD disease signatures
```{r ad-signature, fig.width=8}
gse_df <- gse %>% purrr::map_dfr(~.x) %>% 
  filter(pathway %in% c("KEGG_CHEMOKINE_SIGNALING_PATHWAY",
                        "KEGG_NATURAL_KILLER_CELL_MEDIATED_CYTOTOXICITY",
                        "KEGG_JAK_STAT_SIGNALING_PATHWAY",
                        "KEGG_T_CELL_RECEPTOR_SIGNALING_PATHWAY",
                        "GOBP_KERATINOCYTE_DIFFERENTIATION")) %>% 
  mutate(log10p = -log10(padj))

gse_df %>% 
  ggbarplot(x = "pathway", y = "NES", ylab = "Normalized enrichment score", xlab = "") %>% 
  facet("contrast", nrow = 2) %>% 
  ggpar(rotate = TRUE)

```


### Transcription factor and microRNA targets
```{r gsea-regulatory}
gse_reg <- 
  gse[grep("MIR|TFT", names(gse), value=T)] %>% purrr::map_dfr(~.x) %>% 
  bind_rows(gse[grep("CP:PID", names(gse), value =T)] %>% purrr::map_dfr(~.x) %>% 
              filter(pathway == "PID_P73PATHWAY"))


gse_reg %>% 
  select(gene_set = pathway, padj, NES, contrast) %>% 
  arrange(contrast) %>% 
  mutate(padj = signif(padj, digits = 2), 
         NES = round(NES, digits = 2),
         link = paste0("https://www.gsea-msigdb.org/gsea/msigdb/cards/", gene_set, ".html")) %>% 
  knitr::kable(caption = "Enrichment results for transcription factor and microRNA targets")
```

## Novel targes

### IL34 and IL37
```{r data - IL34, IL37, CSF1, CSF1R}
novel_target_expr <- 
  se[c("IL34", "IL37", "CSF1", "CSF1R")] %>% 
  select(feature, sample, counts_scaled, skin_type) %>% 
  pivot_wider(names_from = feature, values_from = counts_scaled)
```

```{r}
p_IL34_IL37_sep <- 
  novel_target_expr %>% 
  ggscatter(x = "IL34", y = "IL37", add = "reg.line", conf.int = T, color = "skin_type",
            cor.coef = T, cor.method = "spearman", 
            facet.by = "skin_type", scales = "free", palette = pca_color)

png("figure/p_IL34_IL37.png", width = 480 * 2.2 * 3, height = 480 * 1.5 * 2, pointsize = 18, res = 300)
p_IL34_IL37_sep + theme(plot.margin = margin(.1,.5,.1,.1,"cm"))
dev.off()
```

### IL34 and CSF1

```{r}
p_IL34_CSF1_sep <- 
  novel_target_expr %>% 
  ggscatter(x = "IL34", y = "CSF1", add = "reg.line", conf.int = T, color = "skin_type",
            cor.coef = T, cor.method = "spearman", 
            facet.by = "skin_type", scales = "free", palette = pca_color)
png("figure/p_IL34_CSF1.png", width = 480 * 2.2 * 3, height = 480 * 1.5 * 2, pointsize = 18, res = 300)
p_IL34_CSF1_sep + theme(plot.margin = margin(.1,.5,.1,.1,"cm"))
dev.off()
```

### IL34 and CSF1R

```{r}
p_IL34_CSF1R_sep <- 
  novel_target_expr %>% 
  ggscatter(x = "IL34", y = "CSF1R", add = "reg.line", conf.int = T, color = "skin_type",
            cor.coef = T, cor.method = "spearman", 
            facet.by = "skin_type", scales = "free", palette = pca_color)
png("figure/p_IL34_CSF1R.png", width = 480 * 2.2 * 3, height = 480 * 1.5 * 2, pointsize = 18, res = 300)
p_IL34_CSF1R_sep + theme(plot.margin = margin(.1,.5,.1,.1,"cm"))
dev.off()
```




